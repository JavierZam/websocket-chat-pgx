<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PasargameX Chat Testing - Modern UI</title>
    <style>
        :root {
            --primary-color: #007bff;
            --primary-dark: #0056b3;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
            --border-color: #dee2e6;
            --text-color: #212529;
            --text-muted: #6c757d;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --border-radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-color);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 300px 1fr 320px;
            grid-template-rows: auto 1fr;
            gap: 20px;
            height: 100vh;
        }

        .header {
            grid-column: 1 / -1;
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }

        .status-indicator {
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 12px;
        }

        .status-connected {
            background: var(--success-color);
            color: white;
        }

        .status-disconnected {
            background: var(--danger-color);
            color: white;
        }

        .sidebar {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            background: var(--primary-color);
            color: white;
            padding: 15px;
            font-weight: 600;
        }

        .sidebar-content {
            padding: 15px;
            flex: 1;
            overflow-y: auto;
        }

        .user-profile-card {
            background: var(--light-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
        }

        .user-profile-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .user-info h4 {
            margin: 0;
            font-size: 14px;
            color: var(--text-color);
        }

        .user-info p {
            margin: 2px 0 0 0;
            font-size: 12px;
            color: var(--text-muted);
        }

        .chat-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 1px solid var(--border-color);
        }

        .chat-item:hover {
            background: var(--light-bg);
        }

        .chat-item.active {
            background: var(--primary-color);
            color: white;
        }

        .chat-item-info {
            flex: 1;
        }

        .chat-item-title {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .chat-item-preview {
            font-size: 11px;
            opacity: 0.7;
        }

        .chat-item-meta {
            font-size: 10px;
            opacity: 0.6;
        }

        .unread-badge {
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        /* Product Display in Chat */
        .chat-product-section {
            border-top: 1px solid var(--border-color);
            background: var(--light-bg);
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .product-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            gap: 12px;
            transition: box-shadow 0.2s;
        }

        .product-card:hover {
            box-shadow: var(--shadow);
        }

        .product-image {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            object-fit: cover;
            background: var(--light-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .product-info {
            flex: 1;
        }

        .product-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            color: var(--text-color);
        }

        .product-price {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 6px;
        }

        .product-type {
            background: var(--info-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            text-transform: uppercase;
            display: inline-block;
            margin-right: 8px;
        }

        .product-delivery {
            background: var(--success-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            text-transform: uppercase;
            display: inline-block;
        }

        .product-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 80px;
        }

        .buy-instant {
            background: var(--success-color);
            color: white;
        }

        .buy-middleman {
            background: var(--warning-color);
            color: white;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 13px;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-secondary {
            background: var(--text-muted);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--dark-bg);
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .chat-main {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: var(--light-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .chat-details h3 {
            font-size: 16px;
            margin-bottom: 2px;
        }

        .chat-status {
            font-size: 12px;
            color: var(--text-muted);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f5f7fa;
            background-image: 
                radial-gradient(circle at 1px 1px, rgba(255,255,255,0.15) 1px, transparent 0);
            background-size: 20px 20px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }

        .message-self {
            flex-direction: row-reverse;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
        }

        .message-other .message-bubble {
            background: white;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .message-self .message-bubble {
            background: var(--primary-color);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-system .message-bubble {
            background: var(--warning-color);
            color: white;
            max-width: 80%;
            text-align: center;
            font-style: italic;
            border-radius: 12px;
        }

        .message-offer .message-bubble {
            background: linear-gradient(135deg, #ff9a56 0%, #ffad56 100%);
            color: white;
        }

        .message-sender {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
            font-weight: 500;
        }

        .message-content {
            line-height: 1.4;
        }

        .message-meta {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 5px;
            margin-top: 5px;
            font-size: 11px;
            opacity: 0.7;
        }

        .message-time {
            color: inherit;
        }

        .message-status {
            display: flex;
            align-items: center;
        }

        .offer-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }

        .offer-price {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .offer-status {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .offer-status-pending {
            background: var(--warning-color);
            color: white;
        }

        .offer-status-accepted {
            background: var(--success-color);
            color: white;
        }

        .offer-status-rejected {
            background: var(--danger-color);
            color: white;
        }

        .typing-indicator {
            padding: 10px 20px;
            font-style: italic;
            color: var(--text-muted);
            font-size: 14px;
        }

        .chat-input-area {
            border-top: 1px solid var(--border-color);
            background: white;
            padding: 15px 20px;
        }

        .chat-input-toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            resize: none;
            font-size: 14px;
            font-family: inherit;
        }

        .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .send-btn:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .send-btn:disabled {
            background: var(--text-muted);
        }

        /* Image Preview Styles */
        .image-preview-container {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: #f8f9fa;
            max-height: 200px;
            overflow-y: auto;
        }

        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
        }

        .image-preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 6px;
            overflow: hidden;
            border: 2px solid transparent;
            transition: border-color 0.3s;
        }

        .image-preview-item.uploading {
            border-color: #ffc107;
        }

        .image-preview-item.uploaded {
            border-color: #28a745;
        }

        .image-preview-item.error {
            border-color: #dc3545;
        }

        .image-preview-thumb {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 500;
        }

        .image-preview-item.uploaded .image-preview-overlay {
            display: none;
        }

        .image-preview-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #fff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .image-preview-remove {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 18px;
            height: 18px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 10px;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .image-preview-item.uploaded .image-preview-remove {
            display: flex;
        }

        .controls-panel {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow: hidden;
        }

        .panel-section {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .panel-section:last-child {
            border-bottom: none;
        }

        .panel-section h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .online-users {
            max-height: 200px;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 5px;
        }

        .user-item span[onclick] {
            transition: color 0.2s;
        }

        .user-item span[onclick]:hover {
            color: var(--primary-color);
            font-weight: 500;
        }

        .user-online {
            background: rgba(40, 167, 69, 0.1);
            border-left: 3px solid var(--success-color);
        }

        .user-offline {
            background: rgba(108, 117, 125, 0.1);
            border-left: 3px solid var(--text-muted);
        }

        .user-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .user-status-online {
            background: var(--success-color);
        }

        .user-status-offline {
            background: var(--text-muted);
        }

        .logs-area {
            background: #1e1e1e;
            color: #f8f8f2;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 150px;
            overflow-y: auto;
            padding: 10px;
            border-radius: 6px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-success {
            color: #50fa7b;
        }

        .log-error {
            color: #ff5555;
        }

        .log-info {
            color: #8be9fd;
        }

        .log-timestamp {
            color: #6272a4;
            margin-right: 10px;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .floating-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 200px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 500;
            z-index: 1000;
            box-shadow: var(--shadow);
            animation: slideIn 0.3s ease;
        }

        .notification-success {
            background: var(--success-color);
        }

        .notification-error {
            background: var(--danger-color);
        }

        .notification-info {
            background: var(--info-color);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 280px 1fr 280px;
            }
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr auto;
                padding: 10px;
            }

            .sidebar,
            .controls-panel {
                order: 4;
                max-height: 300px;
            }

            .floating-controls {
                position: static;
                margin-top: 20px;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-muted);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    <script src="payment-integration.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                🎮 PasargameX Chat Testing
                <span style="font-size: 14px; color: var(--text-muted); font-weight: normal;">Modern Interface</span>
            </h1>
            <div class="status-bar">
                <div id="authStatus" class="status-indicator status-disconnected">Not Authenticated</div>
                <div id="wsStatus" class="status-indicator status-disconnected">WebSocket Disconnected</div>
                <div style="font-size: 12px; color: var(--text-muted);" id="currentUser">Not logged in</div>
                <div id="userRoleDisplay" class="status-indicator" style="display: none; background: var(--info-color);">
                    <span id="userRoleText">Unknown Role</span>
                </div>
                <div id="rolePermissions" style="font-size: 11px; color: var(--text-muted); display: none;" title="Available permissions for your role">
                    <span id="permissionsText">No permissions loaded</span>
                </div>
            </div>
        </div>

        <!-- Sidebar - Auth & Controls -->
        <div class="sidebar">
            <div class="sidebar-header">
                🔐 Authentication & Setup
            </div>
            <div class="sidebar-content">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="loginEmail" value="javierroyality@gmail.com">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="loginPassword" value="inipassword123">
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="login()">Login</button>
                </div>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border-color);">

                <div class="form-group">
                    <label class="form-label">WebSocket Connection</label>
                    <div class="btn-group">
                        <button class="btn btn-success btn-sm" id="connectBtn" onclick="connectWS()">Connect</button>
                        <button class="btn btn-danger btn-sm" id="disconnectBtn" onclick="disconnectWS()" disabled>Disconnect</button>
                    </div>
                </div>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border-color);">

                <!-- User Profile Search -->
                <div class="form-group">
                    <label class="form-label">Direct Chat Setup</label>
                    <input type="text" class="form-input" id="recipientId" placeholder="Recipient User ID">
                    <input type="text" class="form-input" id="productId" placeholder="Product ID (optional)" style="margin-top: 8px;">
                    <button class="btn btn-primary btn-sm" onclick="quickCreateChat()" style="margin-top: 8px; width: 100%;">Create Direct Chat</button>
                </div>

                <div class="form-group">
                    <label class="form-label">💬 Chat with Seller</label>
                    <input type="text" class="form-input" id="productIdForChat" placeholder="Product ID">
                    <input type="text" class="form-input" id="productChatMessage" placeholder="Initial message" style="margin-top: 8px;">
                    <button class="btn btn-success btn-sm" onclick="createChatByProduct()" style="margin-top: 8px; width: 100%;">Chat with Seller</button>
                </div>

                <div class="form-group">
                    <label class="form-label">🛍️ Group Chat (Buyer)</label>
                    <input type="text" class="form-input" id="groupProductId" placeholder="Product ID">
                    <select class="form-input" id="middlemanSelect" style="margin-top: 8px;">
                        <option value="">Select Middleman...</option>
                    </select>
                    <input type="text" class="form-input" id="groupMessage" placeholder="Initial message" style="margin-top: 8px;">
                    <button class="btn btn-success btn-sm" onclick="createGroupChat()" style="margin-top: 8px; width: 100%;">Create Group Chat</button>
                </div>

                <div class="form-group">
                    <label class="form-label">🏪 Group Chat (Seller)</label>
                    <input type="text" class="form-input" id="sellerProductId" placeholder="Your Product ID">
                    <input type="text" class="form-input" id="buyerIdForSeller" placeholder="Buyer User ID" style="margin-top: 8px;">
                    <select class="form-input" id="middlemanSelectSeller" style="margin-top: 8px;">
                        <option value="">Select Middleman...</option>
                    </select>
                    <input type="text" class="form-input" id="sellerGroupMessage" placeholder="Initial message" style="margin-top: 8px;">
                    <button class="btn btn-warning btn-sm" onclick="createSellerGroupChat()" style="margin-top: 8px; width: 100%;">Invite to Group Chat</button>
                </div>

                <div class="form-group">
                    <label class="form-label">💳 Payment Testing</label>
                    <input type="text" class="form-input" id="paymentProductId" placeholder="Product ID to buy" value="c90158f9-e397-40c7-a076-5229c5e3e652">
                    <button class="btn btn-success btn-sm" onclick="createPaymentTransaction()" style="margin-top: 8px; width: 100%;">🚀 Create Payment Transaction</button>
                    <div style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">
                        This will create a payment transaction and redirect to Midtrans payment page.
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Active Chat</label>
                    <input type="text" class="form-input" id="activeChatId" placeholder="Chat ID">
                    <button class="btn btn-primary btn-sm" onclick="setActiveChat()" style="margin-top: 8px; width: 100%;">Join Chat</button>
                </div>

                <div class="form-group">
                    <label class="form-label">📋 My Chats</label>
                    <div class="btn-group" style="margin-bottom: 8px;">
                        <button class="btn btn-info btn-sm" onclick="loadChatsByType('all')" style="width: 33%;">All</button>
                        <button class="btn btn-primary btn-sm" onclick="loadChatsByType('individual')" style="width: 33%;">💬 Direct</button>
                        <button class="btn btn-success btn-sm" onclick="loadChatsByType('group')" style="width: 34%;">👥 Group</button>
                    </div>
                    <div id="chatsList" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 8px; background: var(--light-bg); display: none;">
                        <!-- Chat list will be populated here -->
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">🔍 Role Detection</label>
                    <div class="btn-group">
                        <button class="btn btn-info btn-sm" onclick="checkMyRole()" style="width: 100%; margin-bottom: 5px;">Check My Role</button>
                        <button class="btn btn-info btn-sm" onclick="getChatParticipants()" style="width: 100%;">Show All Participants</button>
                    </div>
                    <div id="roleInfo" style="margin-top: 8px; padding: 8px; background: var(--light-bg); border-radius: 4px; font-size: 12px; display: none;"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">🎯 Universal Transaction Chat</label>
                    <select class="form-input" id="buyerSelect" style="margin-bottom: 8px;">
                        <option value="">Select Buyer...</option>
                    </select>
                    <select class="form-input" id="sellerSelect" style="margin-bottom: 8px;">
                        <option value="">Select Seller...</option>
                    </select>
                    <select class="form-input" id="productSelect" style="margin-bottom: 8px;">
                        <option value="">Select Product...</option>
                    </select>
                    <select class="form-input" id="transactionMiddlemanSelect" style="margin-bottom: 8px;">
                        <option value="">Select Middleman...</option>
                    </select>
                    <input type="text" class="form-input" id="transactionMessage" placeholder="Initial message" style="margin-bottom: 8px;">
                    <button class="btn btn-success btn-sm" onclick="createTransactionChat()" style="width: 100%;">Create Transaction Chat</button>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-main">
            <div class="chat-header">
                <div class="chat-info">
                    <div class="chat-avatar" id="chatAvatar">💬</div>
                    <div class="chat-details">
                        <h3 id="chatTitle">Select a chat to start</h3>
                        <div class="chat-status" id="chatStatus">No active chat</div>
                        <div id="participantRoles" style="display: none; margin-top: 8px; padding: 8px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; font-size: 12px;">
                            <!-- Participant roles will be displayed here -->
                        </div>
                        <div id="productContext" style="display: none; margin-top: 8px; padding: 8px; background: var(--light-bg); border-radius: 4px; font-size: 12px;">
                            <strong>Product:</strong> <span id="productTitle">-</span><br>
                            <strong>Price:</strong> $<span id="productPrice">0</span><br>
                            <strong>Delivery:</strong> <span id="productDelivery">-</span>
                        </div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-sm btn-primary" onclick="loadMessages()">Refresh</button>
                    <button class="btn btn-sm btn-warning" onclick="markAsRead()">Mark Read</button>
                    <div id="purchaseButtons" style="display: none; margin-top: 8px;">
                        <button class="btn btn-sm btn-success" onclick="purchaseCurrentProduct()" id="purchaseCurrentBtn">Purchase This Item</button>
                        <button class="btn btn-sm btn-info" onclick="showSellerProducts()" id="purchaseOthersBtn">Purchase Other Products</button>
                    </div>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div style="text-align: center; color: var(--text-muted); margin-top: 50px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">💬</div>
                    <h3>Welcome to PasargameX Chat Testing</h3>
                    <p>Login and connect to WebSocket to start testing</p>
                </div>
            </div>

            <div class="typing-indicator" id="typingIndicator" style="display: none;"></div>

            <!-- Products Section -->
            <div class="chat-product-section" id="chatProductSection" style="display: none;">
                <h4 style="margin-bottom: 10px; color: var(--primary-color); font-size: 14px;">🛍️ Available Products</h4>
                <div id="chatProductsList">
                    <!-- Products will be loaded here -->
                </div>
            </div>

            <div class="chat-input-area">
                <div class="chat-input-toolbar">
                    <select id="messageType" class="form-input" style="width: 100px;">
                        <option value="text">Text</option>
                        <option value="image">Image</option>
                        <option value="offer">Offer</option>
                    </select>
                    
                    <input type="text" id="attachmentUrl" class="form-input" placeholder="Attachment URL" style="display: none;">
                    <input type="file" id="imageFiles" class="form-input" multiple accept="image/*" style="display: none;">
                    <div id="imagePreviewContainer" class="image-preview-container" style="display: none;"></div>
                    <input type="number" id="offerPrice" class="form-input" placeholder="Price" style="display: none; width: 100px;">
                </div>

                <div class="input-group">
                    <textarea 
                        id="messageInput" 
                        class="chat-input" 
                        placeholder="Type a message..."
                        rows="1"
                        disabled
                    ></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
                        ➤
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Panel - Users & Logs -->
        <div class="controls-panel">
            <div class="panel-section">
                <h3>👥 Online Users</h3>
                <div class="online-users" id="onlineUsers">
                    <div class="user-item user-offline">
                        <div class="user-status-dot user-status-offline"></div>
                        <span>No users online</span>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <h3>⚡ Quick Actions</h3>
                <div class="quick-actions">
                    <button class="btn btn-sm btn-warning" onclick="testRateLimit()">Test Rate Limit</button>
                    <button class="btn btn-sm btn-info" onclick="testTyping()">Test Typing</button>
                    <button class="btn btn-sm btn-success" onclick="sendTestMessage()">Send Test</button>
                    <button class="btn btn-sm btn-danger" onclick="clearChat()">Clear Chat</button>
                </div>
            </div>

            <div class="panel-section">
                <h3>📊 System Logs</h3>
                <div class="logs-area" id="systemLogs">
                    <div class="log-entry log-info">
                        <span class="log-timestamp">[INIT]</span>
                        System initialized. Ready for testing.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let ws = null;
        let currentToken = '';
        let currentUserId = '';
        let currentUsername = '';
        let currentUserRole = '';
        let activeChatId = '';
        let typingTimeout = null;
        let onlineUsers = new Map();
        let myChats = [];
        let searchedUser = null;
        let rateLimitedUntil = null;
        let rateLimitTimer = null;
        let currentChatProducts = [];
        let otherUserInChat = null;

        // Authentication
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showNotification('Please enter email and password', 'error');
                return;
            }

            try {
                const response = await fetch('https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (response.ok && (data.success || data.token)) {
                    if (data.success) {
                        currentToken = data.data.token;
                        currentUserId = data.data.user.id;
                        currentUsername = data.data.user.username;
                        currentUserRole = data.data.user.role || 'user';
                    } else if (data.token) {
                        currentToken = data.token;
                        currentUserId = data.user.id;
                        currentUsername = data.user.username;
                        currentUserRole = data.user.role || 'user';
                    }
                    
                    updateAuthStatus(true);
                    logMessage('AUTH', `Logged in as ${currentUsername} (${currentUserId})`, 'success');
                    showNotification(`Welcome ${currentUsername}!`, 'success');
                    
                    // Load available middlemen after successful login
                    loadMiddlemen();
                    
                    // Load current user role and permissions
                    loadCurrentUserRole();
                    
                    // Load users and middlemen for transaction chat
                    loadUsersForTransactionChat();
                    
                } else {
                    throw new Error(data.error?.message || data.message || 'Login failed');
                }
            } catch (error) {
                updateAuthStatus(false);
                logMessage('AUTH', `Login failed: ${error.message}`, 'error');
                showNotification(`Login failed: ${error.message}`, 'error');
            }
        }

        // Load current user's global role and permissions
        async function loadCurrentUserRole() {
            if (!currentToken) return;

            try {
                // First try to get user info to determine global role
                const response = await fetch('https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/users/me', {
                    headers: { 'Authorization': 'Bearer ' + currentToken }
                });

                const data = await response.json();
                
                console.log('User Profile API Response:', data); // Debug log
                
                if (data.success && data.data) {
                    const userRole = data.data.role || 'user';
                    updateUserRoleDisplay(userRole);
                    logMessage('ROLE', `Global user role: ${userRole}`, 'success');
                    logMessage('DEBUG', `Full profile data: ${JSON.stringify(data.data)}`, 'info');
                } else {
                    // Fallback: assume role based on available actions
                    updateUserRoleDisplay('user');
                    logMessage('ROLE', 'Using default user role', 'info');
                    logMessage('DEBUG', `Profile API failed: ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                // Fallback: determine role based on available functionality
                updateUserRoleDisplay('user');
                logMessage('ROLE', `Role detection fallback: ${error.message}`, 'warning');
            }
        }

        // Update user role display and permissions
        function updateUserRoleDisplay(role) {
            const roleDisplay = document.getElementById('userRoleDisplay');
            const roleText = document.getElementById('userRoleText');
            const permissionsDiv = document.getElementById('rolePermissions');
            const permissionsText = document.getElementById('permissionsText');

            // Show role display
            roleDisplay.style.display = 'block';
            permissionsDiv.style.display = 'block';

            // Set role text and color
            roleText.textContent = role.toUpperCase();
            
            // Define role colors and permissions
            let roleColor, permissions;
            
            switch(role.toLowerCase()) {
                case 'admin':
                    roleColor = 'linear-gradient(135deg, #ffc107, #ffca2c)'; // Yellow gradient for admin/middleman
                    permissions = ['✓ Create any chat', '✓ Join all chats', '✓ Manage transactions', '✓ Middleman access'];
                    break;
                case 'seller':
                    roleColor = 'linear-gradient(135deg, #28a745, #34ce57)'; // Green gradient for seller
                    permissions = ['✓ Create seller group chats', '✓ Sell products', '✓ Invite buyers'];
                    break;
                case 'buyer':
                    roleColor = 'linear-gradient(135deg, #007bff, #0d6efd)'; // Blue gradient for buyer
                    permissions = ['✓ Create buyer group chats', '✓ Buy products', '✓ Request middleman'];
                    break;
                default:
                    roleColor = 'linear-gradient(135deg, #6c757d, #868e96)'; // Gray gradient for default user
                    permissions = ['✓ Basic chat access', '✓ Send messages'];
            }

            roleDisplay.style.backgroundImage = roleColor;
            roleDisplay.style.color = 'white';
            roleDisplay.style.textShadow = '0 1px 2px rgba(0,0,0,0.3)';
            permissionsText.textContent = permissions.join(' • ');
            permissionsText.title = permissions.join('\n');
            
            // Update UI elements based on role
            updateUIBasedOnRole(role);
        }

        // Update UI elements based on user role - Simplified (no visual changes)
        function updateUIBasedOnRole(role) {
            // No longer change opacity or visibility - just show role info
            // All UI elements remain fully visible and usable regardless of role
            console.log(`UI updated for role: ${role} - All features remain accessible`);
        }

        // WebSocket Connection
        function connectWS() {
            if (!currentToken) {
                showNotification('Please login first', 'error');
                return;
            }

            if (ws && ws.readyState === WebSocket.OPEN) {
                showNotification('WebSocket already connected', 'info');
                return;
            }

            try {
                ws = new WebSocket(`wss://pasargamex-api-is3vukc7iq-et.a.run.app/ws?token=${currentToken}`);
                
                ws.onopen = function() {
                    updateWSStatus(true);
                    logMessage('WS', 'WebSocket connected successfully', 'success');
                    showNotification('WebSocket connected!', 'success');
                    
                    // Auto-join active chat if exists
                    if (activeChatId) {
                        sendWSMessage({ type: "join_chat_room", chat_id: activeChatId });
                    }
                };
                
                ws.onmessage = function(event) {
                    handleWebSocketMessage(event);
                };
                
                ws.onclose = function() {
                    updateWSStatus(false);
                    logMessage('WS', 'WebSocket disconnected', 'error');
                    showNotification('WebSocket disconnected', 'error');
                };
                
                ws.onerror = function(error) {
                    logMessage('WS', `WebSocket error: ${error.message}`, 'error');
                    showNotification('WebSocket error occurred', 'error');
                };
            } catch (error) {
                logMessage('WS', `Connection error: ${error.message}`, 'error');
                showNotification('Failed to connect WebSocket', 'error');
            }
        }

        function disconnectWS() {
            if (ws) {
                if (activeChatId && ws.readyState === WebSocket.OPEN) {
                    sendWSMessage({ type: "leave_chat_room", chat_id: activeChatId });
                }
                ws.close();
            }
        }

        // WebSocket Message Handler
        function handleWebSocketMessage(event) {
            try {
                const data = JSON.parse(event.data);
                logMessage('WS', `Received: ${data.type}`, 'info');

                switch (data.type) {
                    case 'auth_success':
                        showNotification('WebSocket authenticated!', 'success');
                        break;
                    
                    case 'auth_error':
                        showNotification('WebSocket auth failed', 'error');
                        disconnectWS();
                        break;
                    
                    case 'new_message':
                        handleNewMessage(data);
                        break;
                    
                    case 'typing_indicator':
                        handleTypingIndicator(data);
                        break;
                    
                    case 'user_presence':
                        handleUserPresence(data);
                        break;
                    
                    case 'message_read_receipt':
                        handleReadReceipt(data);
                        break;
                    
                    case 'rate_limit_exceeded':
                        handleRateLimit(data);
                        break;
                    
                    case 'offer_update':
                        loadMessages(); // Refresh to show updated offer
                        showNotification(`Offer ${data.status}!`, 'success');
                        break;
                    
                    case 'group_chat_created':
                        handleGroupChatCreated(data);
                        break;
                    
                    case 'payment_status_update':
                        handleWebSocketPaymentUpdate(data);
                        break;
                    
                    default:
                        logMessage('WS', `Unknown message type: ${data.type}`, 'info');
                }
            } catch (e) {
                logMessage('WS', `Parse error: ${e.message}`, 'error');
            }
        }

        // Chat Functions
        async function quickCreateChat() {
            if (!currentToken) {
                showNotification('Please login first', 'error');
                return;
            }

            const recipientId = document.getElementById('recipientId').value.trim();
            const productId = document.getElementById('productId').value.trim();

            if (!recipientId) {
                showNotification('Please enter recipient ID', 'error');
                return;
            }

            // Prevent self-chat in manual setup too
            if (recipientId === currentUserId) {
                showNotification('You cannot create a chat with yourself!', 'error');
                logMessage('CHAT', 'Manual chat creation with self blocked', 'error');
                document.getElementById('recipientId').value = ''; // Clear the input
                return;
            }

            try {
                const response = await fetch('https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + currentToken
                    },
                    body: JSON.stringify({
                        recipient_id: recipientId,
                        product_id: productId || undefined,
                        initial_message: "Chat created from testing interface!"
                    })
                });

                const data = await response.json();
                
                if (data.success && data.data.id) {
                    document.getElementById('activeChatId').value = data.data.id;
                    setActiveChat();
                    loadMyChats(); // Refresh chat list
                    showNotification('Chat created successfully!', 'success');
                    logMessage('CHAT', `Created chat ${data.data.id}`, 'success');
                } else {
                    throw new Error(data.error?.message || 'Failed to create chat');
                }
            } catch (error) {
                showNotification(`Failed to create chat: ${error.message}`, 'error');
                logMessage('CHAT', `Create failed: ${error.message}`, 'error');
            }
        }

        // Load available middlemen on page load
        async function loadMiddlemen() {
            if (!currentToken) return;

            try {
                const response = await fetch('https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats/middlemen', {
                    headers: { 'Authorization': 'Bearer ' + currentToken }
                });

                const data = await response.json();
                
                if (data.success && data.data.middlemen) {
                    const middlemanSelect = document.getElementById('middlemanSelect');
                    const middlemanSelectSeller = document.getElementById('middlemanSelectSeller');
                    
                    // Clear existing options
                    middlemanSelect.innerHTML = '<option value="">Select Middleman...</option>';
                    middlemanSelectSeller.innerHTML = '<option value="">Select Middleman...</option>';
                    
                    data.data.middlemen.forEach(middleman => {
                        const option1 = document.createElement('option');
                        option1.value = middleman.id;
                        option1.textContent = `${middleman.username} (${middleman.email})`;
                        middlemanSelect.appendChild(option1);

                        const option2 = document.createElement('option');
                        option2.value = middleman.id;
                        option2.textContent = `${middleman.username} (${middleman.email})`;
                        middlemanSelectSeller.appendChild(option2);
                    });
                    
                    logMessage('MIDDLEMEN', `Loaded ${data.data.middlemen.length} available middlemen`, 'success');
                } else {
                    throw new Error(data.error?.message || 'Failed to load middlemen');
                }
            } catch (error) {
                logMessage('MIDDLEMEN', `Load failed: ${error.message}`, 'error');
            }
        }

        // Create group chat (buyer initiated)
        async function createGroupChat() {
            if (!currentToken) {
                showNotification('Please login first', 'error');
                return;
            }

            const productId = document.getElementById('groupProductId').value;
            const middlemanId = document.getElementById('middlemanSelect').value;
            const initialMessage = document.getElementById('groupMessage').value;

            if (!productId || !middlemanId) {
                showNotification('Please enter product ID and select middleman', 'error');
                return;
            }

            try {
                const response = await fetch('https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats/group', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + currentToken
                    },
                    body: JSON.stringify({
                        product_id: productId,
                        middleman_id: middlemanId,
                        initial_message: initialMessage || "Group transaction chat created!"
                    })
                });

                const data = await response.json();
                
                if (data.success && data.data.id) {
                    document.getElementById('activeChatId').value = data.data.id;
                    setActiveChat();
                    showNotification('Group chat created successfully!', 'success');
                    logMessage('CHAT', `Created group chat ${data.data.id}`, 'success');
                    
                    // Clear form
                    document.getElementById('groupProductId').value = '';
                    document.getElementById('middlemanSelect').value = '';
                    document.getElementById('groupMessage').value = '';
                } else {
                    throw new Error(data.error?.message || 'Failed to create group chat');
                }
            } catch (error) {
                showNotification(`Failed to create group chat: ${error.message}`, 'error');
                logMessage('CHAT', `Group create failed: ${error.message}`, 'error');
            }
        }

        // Create seller group chat (seller initiated)
        async function createSellerGroupChat() {
            if (!currentToken) {
                showNotification('Please login first', 'error');
                return;
            }

            const productId = document.getElementById('sellerProductId').value;
            const buyerId = document.getElementById('buyerIdForSeller').value;
            const middlemanId = document.getElementById('middlemanSelectSeller').value;
            const initialMessage = document.getElementById('sellerGroupMessage').value;

            if (!productId || !buyerId || !middlemanId) {
                showNotification('Please fill all required fields', 'error');
                return;
            }

            try {
                const response = await fetch('https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats/group/seller', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + currentToken
                    },
                    body: JSON.stringify({
                        product_id: productId,
                        buyer_id: buyerId,
                        middleman_id: middlemanId,
                        initial_message: initialMessage || "Seller invites you to group transaction!"
                    })
                });

                const data = await response.json();
                
                if (data.success && data.data.id) {
                    document.getElementById('activeChatId').value = data.data.id;
                    setActiveChat();
                    showNotification('Seller group chat created successfully!', 'success');
                    logMessage('CHAT', `Created seller group chat ${data.data.id}`, 'success');
                    
                    // Clear form
                    document.getElementById('sellerProductId').value = '';
                    document.getElementById('buyerIdForSeller').value = '';
                    document.getElementById('middlemanSelectSeller').value = '';
                    document.getElementById('sellerGroupMessage').value = '';
                } else {
                    throw new Error(data.error?.message || 'Failed to create seller group chat');
                }
            } catch (error) {
                showNotification(`Failed to create seller group chat: ${error.message}`, 'error');
                logMessage('CHAT', `Seller group create failed: ${error.message}`, 'error');
            }
        }

        // Check current user's role in active chat
        async function checkMyRole() {
            if (!activeChatId || !currentToken) {
                showNotification('Please join a chat first', 'error');
                return;
            }

            try {
                const response = await fetch(`https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats/${activeChatId}/role`, {
                    headers: { 'Authorization': 'Bearer ' + currentToken }
                });

                const data = await response.json();
                
                if (data.success && data.data) {
                    const roleInfo = document.getElementById('roleInfo');
                    roleInfo.style.display = 'block';
                    roleInfo.innerHTML = `
                        <strong>Your Role:</strong> ${data.data.role.toUpperCase()}<br>
                        <strong>Chat ID:</strong> ${data.data.chat_id}<br>
                        <strong>User ID:</strong> ${data.data.user_id}
                    `;
                    
                    showNotification(`Your role: ${data.data.role}`, 'success');
                    logMessage('ROLE', `Current user role: ${data.data.role}`, 'success');
                } else {
                    throw new Error(data.error?.message || 'Failed to get user role');
                }
            } catch (error) {
                showNotification(`Failed to get role: ${error.message}`, 'error');
                logMessage('ROLE', `Role check failed: ${error.message}`, 'error');
            }
        }

        // Get all chat participants with their roles
        async function getChatParticipants() {
            if (!activeChatId || !currentToken) {
                showNotification('Please join a chat first', 'error');
                return;
            }

            try {
                const response = await fetch(`https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats/${activeChatId}/participants`, {
                    headers: { 'Authorization': 'Bearer ' + currentToken }
                });

                const data = await response.json();
                
                if (data.success && data.data) {
                    const roleInfo = document.getElementById('roleInfo');
                    roleInfo.style.display = 'block';
                    
                    let participantsHtml = '<strong>All Participants:</strong><br>';
                    
                    if (data.data.participants && data.data.participants.length > 0) {
                        data.data.participants.forEach(participant => {
                            const roleColor = participant.role === 'seller' ? '#28a745' : 
                                            participant.role === 'buyer' ? '#007bff' : 
                                            participant.role === 'middleman' ? '#ffc107' : '#6c757d';
                            
                            participantsHtml += `
                                <div style="margin: 4px 0; padding: 4px; background: ${roleColor}15; border-left: 3px solid ${roleColor};">
                                    <strong style="color: ${roleColor};">${participant.role.toUpperCase()}</strong><br>
                                    ID: ${participant.user_id}<br>
                                    ${participant.username ? `Name: ${participant.username}` : ''}
                                </div>
                            `;
                        });
                    } else {
                        participantsHtml += '<em>No participants found</em>';
                    }
                    
                    roleInfo.innerHTML = participantsHtml;
                    
                    showNotification('Participants loaded', 'success');
                    logMessage('PARTICIPANTS', `Loaded ${data.data.participants?.length || 0} participants`, 'success');
                } else {
                    throw new Error(data.error?.message || 'Failed to get participants');
                }
            } catch (error) {
                showNotification(`Failed to get participants: ${error.message}`, 'error');
                logMessage('PARTICIPANTS', `Participants load failed: ${error.message}`, 'error');
            }
        }

        // Create chat with seller via product ID
        async function createChatByProduct() {
            if (!currentToken) {
                showNotification('Please login first', 'error');
                return;
            }

            const productId = document.getElementById('productIdForChat').value;
            const initialMessage = document.getElementById('productChatMessage').value;

            if (!productId) {
                showNotification('Please enter a product ID', 'error');
                return;
            }

            try {
                const response = await fetch('https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats/product', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + currentToken
                    },
                    body: JSON.stringify({
                        product_id: productId,
                        initial_message: initialMessage || "Hi, I'm interested in this product!"
                    })
                });

                const data = await response.json();
                
                if (data.success && data.data.id) {
                    document.getElementById('activeChatId').value = data.data.id;
                    setActiveChat();
                    showNotification(`Chat created with seller of ${data.data.product?.title || 'product'}!`, 'success');
                    logMessage('CHAT', `Created chat ${data.data.id} via product ${productId}`, 'success');
                    
                    // Clear form
                    document.getElementById('productIdForChat').value = '';
                    document.getElementById('productChatMessage').value = '';
                } else {
                    throw new Error(data.error?.message || 'Failed to create chat');
                }
            } catch (error) {
                showNotification(`Failed to create chat: ${error.message}`, 'error');
                logMessage('CHAT', `Product chat create failed: ${error.message}`, 'error');
            }
        }

        // Load users for transaction chat creation
        async function loadUsersForTransactionChat() {
            if (!currentToken) return;

            try {
                const response = await fetch('https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats/users', {
                    headers: { 'Authorization': 'Bearer ' + currentToken }
                });

                const data = await response.json();
                
                if (data.success && data.data.users) {
                    const buyerSelect = document.getElementById('buyerSelect');
                    const sellerSelect = document.getElementById('sellerSelect');
                    const transactionMiddlemanSelect = document.getElementById('transactionMiddlemanSelect');
                    
                    // Clear existing options
                    buyerSelect.innerHTML = '<option value="">Select Buyer...</option>';
                    sellerSelect.innerHTML = '<option value="">Select Seller...</option>';
                    transactionMiddlemanSelect.innerHTML = '<option value="">Select Middleman...</option>';
                    
                    data.data.users.forEach(user => {
                        // Add to buyer select
                        const buyerOption = document.createElement('option');
                        buyerOption.value = user.id;
                        buyerOption.textContent = `${user.username} (${user.email}) - ${user.role}`;
                        buyerSelect.appendChild(buyerOption);

                        // Add to seller select
                        const sellerOption = document.createElement('option');
                        sellerOption.value = user.id;
                        sellerOption.textContent = `${user.username} (${user.email}) - ${user.role}`;
                        sellerSelect.appendChild(sellerOption);

                        // Add to middleman select (only admin users)
                        if (user.role === 'admin') {
                            const middlemanOption = document.createElement('option');
                            middlemanOption.value = user.id;
                            middlemanOption.textContent = `${user.username} (${user.email})`;
                            transactionMiddlemanSelect.appendChild(middlemanOption);
                        }
                    });
                    
                    logMessage('USERS', `Loaded ${data.data.users.length} users for transaction chat`, 'success');
                    
                    // Add event listener for seller selection change
                    document.getElementById('sellerSelect').addEventListener('change', function(e) {
                        if (e.target.value) {
                            loadSellerProducts(e.target.value);
                        } else {
                            document.getElementById('productSelect').innerHTML = '<option value="">Select Product...</option>';
                        }
                    });
                    
                } else {
                    throw new Error(data.error?.message || 'Failed to load users');
                }
            } catch (error) {
                logMessage('USERS', `Load failed: ${error.message}`, 'error');
            }
        }

        // Load products for selected seller
        async function loadSellerProducts(sellerId) {
            if (!currentToken || !sellerId) return;

            try {
                const response = await fetch(`https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats/users/${sellerId}/products`, {
                    headers: { 'Authorization': 'Bearer ' + currentToken }
                });

                const data = await response.json();
                
                if (data.success && data.data.products) {
                    const productSelect = document.getElementById('productSelect');
                    productSelect.innerHTML = '<option value="">Select Product...</option>';
                    
                    data.data.products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.title} - Rp ${product.price.toLocaleString('id-ID')}`;
                        productSelect.appendChild(option);
                    });
                    
                    logMessage('PRODUCTS', `Loaded ${data.data.products.length} products for seller`, 'success');
                } else {
                    throw new Error(data.error?.message || 'Failed to load products');
                }
            } catch (error) {
                logMessage('PRODUCTS', `Load failed: ${error.message}`, 'error');
            }
        }

        // Create universal transaction chat
        async function createTransactionChat() {
            if (!currentToken) {
                showNotification('Please login first', 'error');
                return;
            }

            const buyerId = document.getElementById('buyerSelect').value;
            const sellerId = document.getElementById('sellerSelect').value;
            const productId = document.getElementById('productSelect').value;
            const middlemanId = document.getElementById('transactionMiddlemanSelect').value;
            const initialMessage = document.getElementById('transactionMessage').value;

            if (!buyerId || !sellerId || !productId || !middlemanId) {
                showNotification('Please fill all required fields', 'error');
                return;
            }

            if (buyerId === sellerId) {
                showNotification('Buyer and seller cannot be the same person', 'error');
                return;
            }

            try {
                const response = await fetch('https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats/transaction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + currentToken
                    },
                    body: JSON.stringify({
                        buyer_id: buyerId,
                        seller_id: sellerId,
                        product_id: productId,
                        middleman_id: middlemanId,
                        initial_message: initialMessage || "Universal transaction chat created!"
                    })
                });

                const data = await response.json();
                
                if (data.success && data.data.id) {
                    document.getElementById('activeChatId').value = data.data.id;
                    setActiveChat();
                    showNotification('Transaction chat created successfully!', 'success');
                    logMessage('CHAT', `Created transaction chat ${data.data.id}`, 'success');
                    
                    // Clear form
                    document.getElementById('buyerSelect').value = '';
                    document.getElementById('sellerSelect').value = '';
                    document.getElementById('productSelect').value = '';
                    document.getElementById('transactionMiddlemanSelect').value = '';
                    document.getElementById('transactionMessage').value = '';
                } else {
                    throw new Error(data.error?.message || 'Failed to create transaction chat');
                }
            } catch (error) {
                showNotification(`Failed to create transaction chat: ${error.message}`, 'error');
                logMessage('CHAT', `Transaction chat create failed: ${error.message}`, 'error');
            }
        }

        function setActiveChat() {
            const chatId = document.getElementById('activeChatId').value;
            if (!chatId) {
                showNotification('Please enter a chat ID', 'error');
                return;
            }

            // Leave previous chat
            if (activeChatId && ws && ws.readyState === WebSocket.OPEN) {
                sendWSMessage({ type: "leave_chat_room", chat_id: activeChatId });
            }

            activeChatId = chatId;
            updateChatHeader(chatId);
            
            // Join new chat
            if (ws && ws.readyState === WebSocket.OPEN) {
                sendWSMessage({ type: "join_chat_room", chat_id: chatId });
            }

            loadMessages();
            enableChatInput();
            showNotification(`Joined chat ${chatId}`, 'success');
            logMessage('CHAT', `Joined chat ${chatId}`, 'success');
        }

        // Load chats by type (all, individual, group)
        async function loadChatsByType(type) {
            if (!currentToken) {
                showNotification('Please login first', 'error');
                return;
            }

            let endpoint = 'https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats';
            if (type === 'individual') {
                endpoint = 'https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats/individual';
            } else if (type === 'group') {
                endpoint = 'https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats/group';
            }

            try {
                const response = await fetch(endpoint, {
                    headers: { 'Authorization': 'Bearer ' + currentToken }
                });

                const data = await response.json();
                
                if (data.success && data.data.items) {
                    displayChatsList(data.data.items, type);
                    showNotification(`Loaded ${data.data.items.length} ${type} chats`, 'success');
                    logMessage('CHATS', `Loaded ${data.data.items.length} ${type} chats`, 'success');
                } else {
                    throw new Error(data.error?.message || 'Failed to load chats');
                }
            } catch (error) {
                showNotification(`Failed to load chats: ${error.message}`, 'error');
                logMessage('CHATS', `Load failed: ${error.message}`, 'error');
            }
        }

        // Legacy function for compatibility
        async function loadAllChats() {
            return loadChatsByType('all');
        }

        function displayChatsList(chats, type = 'all') {
            const container = document.getElementById('chatsList');
            
            if (chats.length === 0) {
                container.innerHTML = `<p style="text-align: center; color: #6c757d; margin: 10px 0;">No ${type} chats found</p>`;
                container.style.display = 'block';
                return;
            }

            let chatsHtml = chats.map(chat => {
                const isGroupChat = chat.participants && chat.participants.length > 2;
                const chatType = isGroupChat ? '👥' : '💬';
                const chatTitle = chat.product?.title || `Chat ${chat.id.substring(0, 8)}...`;
                const lastMessage = chat.last_message ? 
                    (chat.last_message.length > 30 ? chat.last_message.substring(0, 30) + '...' : chat.last_message) : 
                    'No messages';
                
                const lastMessageTime = chat.last_message_at ? 
                    new Date(chat.last_message_at).toLocaleString([], {
                        month: '2-digit',
                        day: '2-digit', 
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '';

                // Show role information for group chats
                let roleInfo = '';
                if (isGroupChat && (chat.seller_id || chat.buyer_id || chat.middleman_id)) {
                    const roles = [];
                    if (chat.seller_id === currentUserId) roles.push('🏪 Seller');
                    else if (chat.buyer_id === currentUserId) roles.push('🛒 Buyer');
                    else if (chat.middleman_id === currentUserId) roles.push('⚖️ Middleman');
                    
                    if (roles.length > 0) {
                        roleInfo = ` • ${roles[0]}`;
                    }
                }

                return `
                    <div style="
                        border: 1px solid #ddd; 
                        border-radius: 6px; 
                        padding: 10px; 
                        margin: 6px 0; 
                        cursor: pointer; 
                        transition: background-color 0.2s;
                        background: white;
                    " 
                    onclick="selectChat('${chat.id}')"
                    onmouseover="this.style.backgroundColor='#f8f9fa'" 
                    onmouseout="this.style.backgroundColor='white'">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 4px;">
                            <div style="font-weight: bold; display: flex; align-items: center;">
                                <span style="margin-right: 6px;">${chatType}</span>
                                <span style="font-size: 13px;">${escapeHtml(chatTitle)}</span>
                            </div>
                            <div style="font-size: 10px; color: #6c757d;">${lastMessageTime}</div>
                        </div>
                        <div style="font-size: 11px; color: #6c757d; margin-bottom: 4px;">
                            ${escapeHtml(lastMessage)}
                        </div>
                        <div style="font-size: 10px; color: #28a745;">
                            ${isGroupChat ? `${chat.participants.length} participants` : 'Direct chat'}${roleInfo}
                            ${chat.product?.price ? ` • Rp ${chat.product.price.toLocaleString('id-ID')}` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = chatsHtml;
            container.style.display = 'block';
        }

        function selectChat(chatId) {
            document.getElementById('activeChatId').value = chatId;
            setActiveChat();
        }

        async function loadMessages() {
            if (!activeChatId || !currentToken) return;

            try {
                const response = await fetch(`https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats/${activeChatId}/messages`, {
                    headers: { 'Authorization': 'Bearer ' + currentToken }
                });

                const data = await response.json();
                
                if (data.success && data.data.items) {
                    await displayMessages(data.data.items);
                    logMessage('CHAT', `Loaded ${data.data.items.length} messages`, 'success');
                } else {
                    throw new Error(data.error?.message || 'Failed to load messages');
                }
            } catch (error) {
                logMessage('CHAT', `Load failed: ${error.message}`, 'error');
            }
        }

        async function sendMessage() {
            if (!activeChatId || !currentToken) {
                showNotification('No active chat selected', 'error');
                return;
            }

            // Check rate limit
            if (isRateLimited()) {
                showNotification('You are currently rate limited. Please wait.', 'error');
                return;
            }

            const content = document.getElementById('messageInput').value.trim();
            const messageType = document.getElementById('messageType').value;
            const attachmentUrl = document.getElementById('attachmentUrl').value;
            const offerPrice = document.getElementById('offerPrice').value;
            const files = document.getElementById('imageFiles').files;

            // For image type, need either attachment URL or files, plus optional content
            if (messageType === 'image') {
                if (!attachmentUrl && files.length === 0) {
                    showNotification('Please provide image URL or select files to upload', 'error');
                    return;
                }
                // If files are selected, upload them first
                if (files.length > 0) {
                    await sendMessageWithFileUpload(content, files);
                    return;
                }
            } else {
                // For non-image messages, content is required
                if (!content) return;
            }

            let messageData = {
                content: content,
                type: messageType
            };

            if (messageType === 'image' && attachmentUrl) {
                // Handle multiple image URLs separated by comma
                const urls = attachmentUrl.split(',').map(url => url.trim()).filter(url => url);
                if (urls.length > 1) {
                    // Send multiple images as separate messages
                    let successCount = 0;
                    let failCount = 0;
                    
                    for (let i = 0; i < urls.length; i++) {
                        // Only first image gets the user's text content, rest get default 'Image'
                        const imageContent = (i === 0 && content.trim()) ? content : 'Image';
                        const singleMessageData = {
                            content: imageContent,
                            type: messageType,
                            attachment_url: urls[i]
                        };
                        
                        try {
                            const response = await fetch(`https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats/${activeChatId}/messages`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': 'Bearer ' + currentToken
                                },
                                body: JSON.stringify(singleMessageData)
                            });
                            
                            const responseData = await response.json();
                            if (responseData.success) {
                                // Add message to UI immediately (optimistic update)
                                addMessageToUI(responseData.data, true);
                                logMessage('CHAT', `Image message ${i + 1}/${urls.length} sent`, 'success');
                                successCount++;
                            } else {
                                logMessage('CHAT', `Failed to send image ${i + 1}: ${responseData.message}`, 'error');
                                failCount++;
                            }
                        } catch (error) {
                            logMessage('CHAT', `Error sending image ${i + 1}: ${error.message}`, 'error');
                            failCount++;
                        }
                    }
                    
                    // Clear inputs and previews after sending all images
                    document.getElementById('messageInput').value = '';
                    document.getElementById('attachmentUrl').value = '';
                    document.getElementById('imageFiles').value = '';
                    document.getElementById('imagePreviewContainer').innerHTML = '';
                    
                    // Ensure chat scrolls to bottom after all images
                    const container = document.getElementById('chatMessages');
                    setTimeout(() => {
                        container.scrollTop = container.scrollHeight;
                    }, 100);
                    
                    // Refresh chat messages to ensure we have the latest (in case WebSocket missed anything)
                    setTimeout(() => {
                        if (activeChatId) {
                            loadChatMessages(activeChatId);
                        }
                    }, 500);
                    
                    // Stop typing indicator
                    sendWSMessage({ type: "typing_stop", chat_id: activeChatId });
                    
                    logMessage('CHAT', `Sent ${successCount}/${urls.length} image messages`, successCount > 0 ? 'success' : 'error');
                    
                    if (successCount === urls.length) {
                        showNotification(`Successfully sent all ${successCount} images`, 'success');
                    } else if (successCount > 0) {
                        showNotification(`Sent ${successCount}/${urls.length} images (${failCount} failed)`, 'warning');
                    } else {
                        showNotification(`Failed to send all ${urls.length} images`, 'error');
                    }
                    return; // Exit early since we handled multiple images
                } else {
                    messageData.attachment_url = urls[0] || attachmentUrl;
                }
            } else if (messageType === 'offer' && offerPrice) {
                const priceValue = parseFloat(offerPrice);
                
                // Validate offer price (minimum 1000 IDR, maximum 1 billion IDR)
                if (priceValue < 1000) {
                    showNotification('Offer price must be at least Rp 1,000', 'error');
                    return;
                }
                if (priceValue > 1000000000) {
                    showNotification('Offer price cannot exceed Rp 1,000,000,000', 'error');
                    return;
                }
                
                messageData.metadata = {
                    price: priceValue,
                    status: "pending"
                };
                
                // Add product_id if available from current chat context
                if (window.currentChatProduct && window.currentChatProduct.id) {
                    messageData.metadata.product_id = window.currentChatProduct.id;
                    logMessage('OFFER', `Including product_id: ${window.currentChatProduct.id}`, 'info');
                } else {
                    logMessage('OFFER', 'No product context available for offer', 'warning');
                }
            }

            try {
                const response = await fetch(`https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats/${activeChatId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + currentToken
                    },
                    body: JSON.stringify(messageData)
                });

                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('messageInput').value = '';
                    document.getElementById('attachmentUrl').value = '';
                    document.getElementById('offerPrice').value = '';
                    document.getElementById('imageFiles').value = '';
                    document.getElementById('imagePreviewContainer').innerHTML = '';
                    
                    // Add message to UI immediately (optimistic update)
                    addMessageToUI(data.data, true);
                    
                    // Stop typing indicator
                    sendWSMessage({ type: "typing_stop", chat_id: activeChatId });
                    
                    logMessage('CHAT', `Sent ${messageType} message`, 'success');
                } else {
                    throw new Error(data.error?.message || 'Failed to send message');
                }
            } catch (error) {
                showNotification(`Failed to send message: ${error.message}`, 'error');
                logMessage('CHAT', `Send failed: ${error.message}`, 'error');
            }
        }

        // Message Display
        async function displayMessages(messages) {
            const container = document.getElementById('chatMessages');
            container.innerHTML = '';
            
            // Load usernames for all senders
            await loadUsernamesForMessages(messages);
            
            messages.reverse().forEach(message => {
                addMessageToUI(message, message.sender_id === currentUserId);
            });
            
            container.scrollTop = container.scrollHeight;
        }

        // Cache usernames to avoid repeated API calls
        window.usernameCache = window.usernameCache || {};

        async function loadUsernamesForMessages(messages) {
            const uniqueSenderIds = [...new Set(messages.map(m => m.sender_id).filter(id => id && id !== 'system'))];
            
            for (const senderId of uniqueSenderIds) {
                if (!window.usernameCache[senderId]) {
                    try {
                        const response = await fetch(`https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/users/${senderId}`, {
                            headers: { 'Authorization': 'Bearer ' + currentToken }
                        });
                        const data = await response.json();
                        if (data.success && data.data) {
                            window.usernameCache[senderId] = data.data.username;
                        }
                    } catch (error) {
                        console.error(`Failed to load username for ${senderId}:`, error);
                        window.usernameCache[senderId] = 'Unknown User';
                    }
                }
            }
        }

        function addMessageToUI(message, isSelf) {
            const container = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `message ${isSelf ? 'message-self' : 'message-other'}`;
            if (message.type === 'system') messageDiv.className += ' message-system';
            if (message.type === 'offer') messageDiv.className += ' message-offer';
            
            messageDiv.dataset.messageId = message.id;

            let contentHtml = escapeHtml(message.content);
            let metaHtml = '';
            let actionsHtml = '';

            // Handle different message types
            if (message.type === 'image') {
                let imagesHtml = '';
                
                // Set current message metadata for secure URL extraction
                window.currentMessageMetadata = message.metadata || {};
                
                // Handle multiple images (new format)
                if (message.attachment_urls && message.attachment_urls.length > 0) {
                    // Show text content first if exists
                    if (message.content && message.content.trim() !== 'Images' && message.content.trim() !== 'Image') {
                        contentHtml = `<div style="margin-bottom: 8px;">${escapeHtml(message.content)}</div>`;
                    } else {
                        contentHtml = '';
                    }
                    
                    // Create image gallery
                    const imageCount = message.attachment_urls.length;
                    const galleryStyle = imageCount === 1 ? 
                        'display: block;' : 
                        `display: grid; grid-template-columns: repeat(${Math.min(imageCount, 2)}, 1fr); gap: 4px; max-width: 300px;`;
                    
                    imagesHtml = `<div style="${galleryStyle}">`;
                    message.attachment_urls.forEach(url => {
                        const imageStyle = imageCount === 1 ? 
                            'max-width: 250px; width: 100%;' : 
                            'width: 100%; aspect-ratio: 1; object-fit: cover; max-width: 150px;';
                        // Use direct storage URL (simple and fast for public chat images)
                        imagesHtml += `<img src="${url}" alt="Image" style="${imageStyle} border-radius: 8px; cursor: pointer;" referrerpolicy="no-referrer" onclick="openSecureImage('${url}')">`;
                    });
                    imagesHtml += '</div>';
                    
                    contentHtml += imagesHtml;
                }
                // Handle single image (backward compatibility)
                else if (message.attachment_url) {
                    // Show text content first if exists
                    if (message.content && message.content.trim() !== 'Images' && message.content.trim() !== 'Image') {
                        contentHtml = `<div style="margin-bottom: 8px;">${escapeHtml(message.content)}</div>`;
                    } else {
                        contentHtml = '';
                    }
                    // Use direct storage URL (simple and fast for public chat images)
                    contentHtml += `<img src="${message.attachment_url}" alt="Image" style="max-width: 250px; border-radius: 8px; cursor: pointer;" referrerpolicy="no-referrer" onclick="openSecureImage('${message.attachment_url}')">`;
                }
            } else if (message.type === 'offer' && message.metadata) {
                const price = message.metadata.price || 0;
                const status = message.metadata.status || 'pending';
                
                contentHtml = `
                    <div class="offer-price">Rp ${price.toLocaleString('id-ID')}</div>
                    <div>${escapeHtml(message.content)}</div>
                    <div class="offer-status offer-status-${status}">${status}</div>
                `;

                if (!isSelf && status === 'pending') {
                    actionsHtml = `
                        <div class="offer-actions">
                            <button class="btn btn-success btn-sm" onclick="respondToOffer('${message.chat_id}', '${message.id}', 'accept')">Accept</button>
                            <button class="btn btn-danger btn-sm" onclick="respondToOffer('${message.chat_id}', '${message.id}', 'reject')">Reject</button>
                        </div>
                    `;
                }
            } else if (message.type === 'system' && message.metadata) {
                // Handle special system messages
                if (message.metadata.transaction_id && message.metadata.credentials) {
                    // Instant delivery credentials
                    const credentials = message.metadata.credentials;
                    contentHtml = `
                        <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <span style="font-size: 24px; margin-right: 8px;">🎮</span>
                                <strong>Account Credentials Delivered!</strong>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px; margin: 10px 0; font-family: monospace;">
                                <div style="margin-bottom: 8px;"><strong>Username:</strong> ${escapeHtml(credentials.username || 'N/A')}</div>
                                <div style="margin-bottom: 8px;"><strong>Password:</strong> ${escapeHtml(credentials.password || 'N/A')}</div>
                                ${credentials.email ? `<div style="margin-bottom: 8px;"><strong>Email:</strong> ${escapeHtml(credentials.email)}</div>` : ''}
                                ${credentials.notes ? `<div style="color: #6c757d; font-size: 12px;">${escapeHtml(credentials.notes)}</div>` : ''}
                            </div>
                            <div style="font-size: 12px; color: #155724;">
                                Transaction ID: ${escapeHtml(message.metadata.transaction_id)}
                            </div>
                        </div>
                    `;
                } else if (message.metadata.payment_status) {
                    // Payment status updates
                    const status = message.metadata.payment_status;
                    const statusColor = status === 'paid' ? '#155724' : status === 'failed' ? '#721c24' : '#856404';
                    const statusBg = status === 'paid' ? '#d4edda' : status === 'failed' ? '#f8d7da' : '#fff3cd';
                    const statusIcon = status === 'paid' ? '✅' : status === 'failed' ? '❌' : '⏳';
                    
                    contentHtml = `
                        <div style="background: ${statusBg}; color: ${statusColor}; padding: 12px; border-radius: 6px; text-align: center;">
                            ${statusIcon} ${escapeHtml(message.content)}
                        </div>
                    `;
                }
            }

            // Handle product embed in message metadata
            if (message.metadata && message.metadata.product_embed) {
                const productEmbed = message.metadata.product_embed;
                const buyerInfo = message.metadata.buyer_info;
                
                // Create product embed card + original message text below
                contentHtml = `
                    <div class="product-embed" style="
                        border: 1px solid #e1e5e9; 
                        border-radius: 8px; 
                        padding: 12px; 
                        margin: 8px 0; 
                        background: #f8f9fa;
                    ">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <div style="
                                width: 40px; 
                                height: 40px; 
                                border-radius: 8px; 
                                background: linear-gradient(45deg, #28a745 0%, #20c997 100%); 
                                display: flex; 
                                align-items: center; 
                                justify-content: center; 
                                color: white; 
                                font-weight: bold; 
                                margin-right: 12px;
                                font-size: 18px;
                            ">🎮</div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: #495057; font-size: 16px;">${escapeHtml(productEmbed.product_title)}</div>
                                <div style="color: #28a745; font-weight: bold; font-size: 18px;">Rp ${productEmbed.product_price.toLocaleString('id-ID')}</div>
                                <div style="font-size: 12px; color: #6c757d;">Delivery: ${escapeHtml(productEmbed.delivery_method)}</div>
                            </div>
                        </div>
                        ${buyerInfo ? `
                            <div style="border-top: 1px solid #dee2e6; padding-top: 8px; font-size: 12px; color: #6c757d;">
                                <strong style="color: #007bff;">Interested Buyer:</strong> 
                                <span onclick="navigateToProfile('${buyerInfo.buyer_id}')" style="color: #007bff; cursor: pointer; text-decoration: underline;">
                                    ${escapeHtml(buyerInfo.username)}
                                </span>
                            </div>
                        ` : ''}
                    </div>
                    <div style="margin-top: 8px; padding: 8px 0;">${escapeHtml(message.content)}</div>
                `;
            }

            // Message meta (time and status)
            const time = new Date(message.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            if (isSelf) {
                const readStatus = message.read_by && message.read_by.length > 1 ? '✓✓' : '✓';
                metaHtml = `
                    <div class="message-meta">
                        <span class="message-time">${time}</span>
                        <span class="message-status">${readStatus}</span>
                    </div>
                `;
            } else {
                metaHtml = `<div class="message-meta"><span class="message-time">${time}</span></div>`;
            }

            const senderName = window.usernameCache[message.sender_id] || 'Unknown';
            const senderHtml = !isSelf && message.type !== 'system' ? `<div class="message-sender">${escapeHtml(senderName)}</div>` : '';

            messageDiv.innerHTML = `
                <div class="message-bubble">
                    ${senderHtml}
                    <div class="message-content">${contentHtml}</div>
                    ${metaHtml}
                    ${actionsHtml}
                </div>
            `;

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Utility Functions
        function sendWSMessage(data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(data));
            }
        }

        function updateAuthStatus(isAuth) {
            const statusEl = document.getElementById('authStatus');
            const userEl = document.getElementById('currentUser');
            const roleDisplay = document.getElementById('userRoleDisplay');
            const permissionsDiv = document.getElementById('rolePermissions');
            
            if (isAuth) {
                statusEl.textContent = 'Authenticated';
                statusEl.className = 'status-indicator status-connected';
                userEl.textContent = `${currentUsername} (${currentUserId})`;
            } else {
                statusEl.textContent = 'Not Authenticated';
                statusEl.className = 'status-indicator status-disconnected';
                userEl.textContent = 'Not logged in';
                
                // Hide role display when not authenticated
                roleDisplay.style.display = 'none';
                permissionsDiv.style.display = 'none';
                
                // Reset UI elements
                const sellerGroupSection = document.querySelector('div:has(#sellerProductId)')?.parentElement;
                const buyerGroupSection = document.querySelector('div:has(#groupProductId)')?.parentElement;
                if (sellerGroupSection) {
                    sellerGroupSection.style.display = 'block';
                    sellerGroupSection.style.opacity = '1';
                }
                if (buyerGroupSection) {
                    buyerGroupSection.style.display = 'block';
                    buyerGroupSection.style.opacity = '1';
                }
            }
        }

        function updateWSStatus(isConnected) {
            const statusEl = document.getElementById('wsStatus');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            if (isConnected) {
                statusEl.textContent = 'WebSocket Connected';
                statusEl.className = 'status-indicator status-connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusEl.textContent = 'WebSocket Disconnected';
                statusEl.className = 'status-indicator status-disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        async function updateChatHeader(chatId) {
            document.getElementById('chatTitle').textContent = `Chat ${chatId.substring(0, 8)}...`;
            document.getElementById('chatStatus').textContent = 'Active chat';
            
            // Hide participant roles initially (will be shown for group chats)
            document.getElementById('participantRoles').style.display = 'none';
            
            // Load chat details including product info
            await loadChatDetails(chatId);
        }

        async function loadChatDetails(chatId) {
            if (!currentToken) return;

            try {
                const response = await fetch(`https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats/${chatId}`, {
                    headers: { 'Authorization': 'Bearer ' + currentToken }
                });

                const data = await response.json();
                
                if (data.success && data.data) {
                    const chat = data.data;
                    
                    // Store chat data and participants for purchase button functionality  
                    window.currentChatData = chat;
                    window.currentChatParticipants = chat.participants || [];
                    
                    // Show product context if chat has product
                    if (chat.product_id) {
                        await showProductContext(chat.product_id);
                        showPurchaseButtons();
                    } else {
                        hideProductContext();
                    }
                    
                    // Update chat title with participant info and roles for group chats
                    if (chat.participants && chat.participants.length > 2) {
                        document.getElementById('chatTitle').textContent = `Group Chat (${chat.participants.length} members)`;
                        
                        // Load and display participant roles
                        loadAndDisplayParticipantRoles(chatId);
                    }
                }
            } catch (error) {
                console.error('Failed to load chat details:', error);
            }
        }

        // Load and display participant roles in group chat header
        async function loadAndDisplayParticipantRoles(chatId) {
            if (!currentToken) return;

            try {
                const response = await fetch(`https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats/${chatId}/participants`, {
                    headers: { 'Authorization': 'Bearer ' + currentToken }
                });

                const data = await response.json();
                
                if (data.success && data.data && data.data.participants) {
                    displayParticipantRoles(data.data.participants);
                }
            } catch (error) {
                console.error('Failed to load participant roles:', error);
            }
        }

        function displayParticipantRoles(participants) {
            const container = document.getElementById('participantRoles');
            
            if (!participants || participants.length === 0) {
                container.style.display = 'none';
                return;
            }

            // Group participants by role
            const seller = participants.find(p => p.role === 'seller');
            const buyer = participants.find(p => p.role === 'buyer');
            const middleman = participants.find(p => p.role === 'middleman' || p.role === 'admin');
            
            let rolesHtml = '<strong>👥 Transaction Participants:</strong><br>';
            
            if (seller) {
                rolesHtml += `<span style="color: #28a745; font-weight: bold;">🏪 SELLER:</span> ${escapeHtml(seller.username)}<br>`;
            }
            
            if (buyer) {
                rolesHtml += `<span style="color: #007bff; font-weight: bold;">🛒 BUYER:</span> ${escapeHtml(buyer.username)}<br>`;
            }
            
            if (middleman) {
                rolesHtml += `<span style="color: #fd7e14; font-weight: bold;">⚖️ MIDDLEMAN:</span> ${escapeHtml(middleman.username)}`;
            }

            // Add role information for current user
            const currentUserParticipant = participants.find(p => p.user_id === currentUserId);
            if (currentUserParticipant) {
                rolesHtml += `<br><small style="color: #6c757d;">You are the <strong>${currentUserParticipant.role.toUpperCase()}</strong></small>`;
            }

            container.innerHTML = rolesHtml;
            container.style.display = 'block';
        }

        async function showProductContext(productId) {
            if (!currentToken) return;

            try {
                const response = await fetch(`https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/products/${productId}`, {
                    headers: { 'Authorization': 'Bearer ' + currentToken }
                });

                const data = await response.json();
                
                if (data.success && data.data) {
                    const product = data.data;
                    document.getElementById('productTitle').textContent = product.title;
                    document.getElementById('productPrice').textContent = product.price.toLocaleString();
                    document.getElementById('productDelivery').textContent = product.delivery_method || 'manual';
                    document.getElementById('productContext').style.display = 'block';
                    
                    // Store current product for purchase functions
                    window.currentChatProduct = product;
                }
            } catch (error) {
                console.error('Failed to load product details:', error);
            }
        }

        function hideProductContext() {
            document.getElementById('productContext').style.display = 'none';
            document.getElementById('purchaseButtons').style.display = 'none';
            window.currentChatProduct = null;
        }

        function showPurchaseButtons() {
            // Don't show purchase buttons in middleman group chats
            if (window.currentChatData && window.currentChatData.middleman_id) {
                // This is a middleman group chat - transaction is already in progress
                document.getElementById('purchaseButtons').style.display = 'none';
                return;
            }
            
            // Don't show purchase buttons if current user is the seller
            if (window.currentChatProduct && window.currentChatProduct.seller_id === currentUserId) {
                document.getElementById('purchaseButtons').style.display = 'none';
                return;
            }
            
            document.getElementById('purchaseButtons').style.display = 'block';
        }

        // Purchase current product in chat
        async function purchaseCurrentProduct() {
            if (!window.currentChatProduct) {
                showNotification('No product selected', 'error');
                return;
            }

            const product = window.currentChatProduct;
            const deliveryMethod = product.delivery_method || 'manual';

            if (deliveryMethod === 'instant') {
                // Show payment options for instant delivery
                showPaymentOptions(product);
            } else if (deliveryMethod === 'middleman') {
                // Show middleman selection for middleman delivery
                showMiddlemanSelection(product);
            } else {
                // Manual delivery - show payment options with manual note
                showPaymentOptions(product, 'manual');
            }
        }

        // Show seller's other products
        async function showSellerProducts() {
            if (!window.currentChatProduct || !activeChatId) {
                showNotification('No active chat or product', 'error');
                return;
            }

            try {
                const response = await fetch(`https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats/users/${window.currentChatProduct.seller_id}/products`, {
                    headers: { 'Authorization': 'Bearer ' + currentToken }
                });

                const data = await response.json();
                
                if (data.success && data.data.products) {
                    displaySellerProductsModal(data.data.products);
                } else {
                    showNotification('Failed to load seller products', 'error');
                }
            } catch (error) {
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        function showPaymentOptions(product, deliveryNote = '') {
            const deliveryMethod = product.delivery_method || 'manual';
            
            let deliveryInfo = '';
            let paymentButtons = '';
            
            if (deliveryMethod === 'instant') {
                deliveryInfo = `
                    <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 12px; border-radius: 6px; margin: 15px 0;">
                        <strong>🚀 INSTANT DELIVERY</strong><br>
                        <small>Credentials will be automatically displayed after payment confirmation</small>
                    </div>
                `;
                paymentButtons = `
                    <button class="btn btn-success buy-instant" onclick="createInstantTransaction('${product.id}')" style="width: 100%; margin-bottom: 10px;">
                        💳 Pay Now - Get Instant Credentials
                    </button>
                `;
            } else if (deliveryMethod === 'middleman') {
                deliveryInfo = `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 12px; border-radius: 6px; margin: 15px 0;">
                        <strong>👥 MIDDLEMAN DELIVERY</strong><br>
                        <small>Transaction handled by trusted middleman for security</small>
                    </div>
                `;
                paymentButtons = `
                    <button class="btn btn-warning buy-middleman" onclick="selectMiddlemanForPayment('${product.id}')" style="width: 100%; margin-bottom: 10px;">
                        🛡️ Select Middleman
                    </button>
                `;
            } else {
                deliveryInfo = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 12px; border-radius: 6px; margin: 15px 0;">
                        <strong>📋 MANUAL DELIVERY</strong><br>
                        <small>Choose your preferred payment method</small>
                    </div>
                `;
                paymentButtons = `
                    <button class="btn btn-primary" onclick="createInstantTransaction('${product.id}')" style="margin-right: 10px;">
                        💳 Payment Gateway
                    </button>
                    <button class="btn btn-warning" onclick="selectMiddlemanForPayment('${product.id}')">
                        👥 Use Middleman
                    </button>
                `;
            }

            const modal = `
                <div id="paymentModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 20px; border-radius: 8px; max-width: 450px; width: 90%;">
                        <h3>🛒 Purchase: ${product.title}</h3>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin: 10px 0;">
                            <strong>💰 Price: Rp ${product.price.toLocaleString('id-ID')}</strong>
                        </div>
                        
                        ${deliveryInfo}
                        
                        <div style="margin: 20px 0;">
                            ${paymentButtons}
                        </div>
                        
                        <button class="btn btn-secondary" onclick="closeModal('paymentModal')" style="width: 100%; margin-top: 10px;">❌ Cancel</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
        }

        function showMiddlemanSelection(product) {
            // Auto-detect buyer/seller based on chat context
            if (!activeChatId || !window.currentChatParticipants) {
                showNotification('Chat context not available', 'error');
                return;
            }
            
            // Don't allow middleman selection if already in a middleman group chat
            if (window.currentChatData && window.currentChatData.middleman_id) {
                showNotification('This is already a middleman transaction chat', 'info');
                return;
            }

            // Automatically determine buyer and seller from chat context
            let buyerId, sellerId;
            
            // Get seller from product
            sellerId = product.seller_id;
            
            // Check if current user is admin - admins should not initiate purchases
            if (currentUserRole === 'admin') {
                showNotification('Admin users cannot initiate purchases. Admins should only act as middlemen in transactions.', 'error');
                return;
            }
            
            // Check if current user is the seller
            if (currentUserId === sellerId) {
                showNotification('Sellers cannot purchase their own products', 'error');
                return;
            }
            
            // Current user becomes the buyer (since they're not seller or admin)
            buyerId = currentUserId;

            if (!buyerId || !sellerId) {
                showNotification('Cannot determine buyer/seller from chat context', 'error');
                return;
            }

            // Final validation: ensure all participants are different
            if (buyerId === sellerId) {
                showNotification('Buyer and seller cannot be the same person', 'error');
                return;
            }

            showMiddlemanSelectionModal(product.id, buyerId, sellerId);
        }

        async function showMiddlemanSelectionModal(productId, buyerId, sellerId) {
            try {
                // Load available middlemen
                const response = await fetch('https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats/middlemen', {
                    headers: { 'Authorization': 'Bearer ' + currentToken }
                });
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error?.message || 'Failed to load middlemen');
                }

                const middlemen = data.data?.middlemen || [];
                
                let middlemenHtml = middlemen.map(middleman => `
                    <div style="border: 1px solid #ddd; padding: 12px; margin: 8px 0; border-radius: 6px; cursor: pointer; transition: background-color 0.2s;" 
                         onclick="createMiddlemanTransaction('${productId}', '${buyerId}', '${sellerId}', '${middleman.id}', '${middleman.username}')"
                         onmouseover="this.style.backgroundColor='#f8f9fa'" 
                         onmouseout="this.style.backgroundColor='white'">
                        <div style="display: flex; align-items: center;">
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: #28a745; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; margin-right: 8px;">
                                ${middleman.username.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <strong>${middleman.username}</strong>
                                <div style="font-size: 12px; color: #6c757d;">${middleman.email}</div>
                            </div>
                        </div>
                    </div>
                `).join('');

                if (middlemen.length === 0) {
                    middlemenHtml = '<p style="text-align: center; color: #6c757d;">No middlemen available</p>';
                }

                const modal = `
                    <div id="middlemanModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                        <div style="background: white; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%; max-height: 80%; overflow-y: auto;">
                            <h3>🛡️ Select Middleman</h3>
                            <p style="color: #6c757d; margin-bottom: 15px;">Choose a trusted middleman for this transaction</p>
                            <div style="margin: 20px 0;">
                                ${middlemenHtml}
                            </div>
                            <button class="btn btn-secondary" onclick="closeModal('middlemanModal')" style="width: 100%; margin-top: 10px;">Cancel</button>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modal);
                
            } catch (error) {
                showNotification(`Failed to load middlemen: ${error.message}`, 'error');
            }
        }

        async function createMiddlemanTransaction(productId, buyerId, sellerId, middlemanId, middlemanName) {
            try {
                closeModal('middlemanModal');
                
                const response = await fetch('https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats/transaction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + currentToken
                    },
                    body: JSON.stringify({
                        buyer_id: buyerId,
                        seller_id: sellerId,
                        product_id: productId,
                        middleman_id: middlemanId,
                        initial_message: `Transaction chat created with middleman ${middlemanName} for purchase request.`
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showNotification('Middleman transaction chat created successfully!', 'success');
                    
                    // Navigate to the newly created chat
                    if (data.data && data.data.id) {
                        document.getElementById('activeChatId').value = data.data.id;
                        setActiveChat();
                        showNotification(`Joined new transaction chat: ${data.data.id}`, 'info');
                    }
                } else {
                    throw new Error(data.error?.message || 'Failed to create transaction chat');
                }
            } catch (error) {
                showNotification(`Failed to create transaction: ${error.message}`, 'error');
            }
        }

        // Function to navigate to user profile
        function navigateToProfile(userId) {
            // For now, show user information in a modal
            // In a real app, this would navigate to the user's profile page
            showUserProfileModal(userId);
        }

        async function showUserProfileModal(userId) {
            try {
                const response = await fetch(`https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/users/${userId}`, {
                    headers: { 'Authorization': 'Bearer ' + currentToken }
                });
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error?.message || 'Failed to load user profile');
                }

                const user = data.data;
                const modal = `
                    <div id="profileModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                        <div style="background: white; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%;">
                            <h3>👤 User Profile</h3>
                            <div style="display: flex; align-items: center; margin: 15px 0;">
                                <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(45deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 20px; margin-right: 15px;">
                                    ${user.username.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <div style="font-weight: bold; font-size: 18px;">${escapeHtml(user.username)}</div>
                                    <div style="color: #6c757d;">${escapeHtml(user.email)}</div>
                                    <div style="color: #28a745; font-weight: bold; text-transform: uppercase;">${escapeHtml(user.role || 'user')}</div>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="closeModal('profileModal')" style="width: 100%;">Close</button>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modal);
                
            } catch (error) {
                showNotification(`Failed to load profile: ${error.message}`, 'error');
            }
        }

        function displaySellerProductsModal(products) {
            let productsHtml = products.map(product => `
                <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px;">
                    <strong>${product.title}</strong><br>
                    Price: Rp ${product.price.toLocaleString('id-ID')}<br>
                    Delivery: ${product.delivery_method || 'manual'}<br>
                    <button class="btn btn-sm btn-success" onclick="purchaseSpecificProduct('${product.id}')" style="margin-top: 5px;">Purchase</button>
                </div>
            `).join('');

            const modal = `
                <div id="productsModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 20px; border-radius: 8px; max-width: 500px; width: 90%; max-height: 80%; overflow-y: auto;">
                        <h3>Seller's Products</h3>
                        <div style="margin: 20px 0;">
                            ${productsHtml}
                        </div>
                        <button class="btn btn-secondary" onclick="closeModal('productsModal')" style="width: 100%;">Close</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
        }

        async function purchaseSpecificProduct(productId) {
            // Load product details and show payment options
            try {
                const response = await fetch(`https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/products/${productId}`, {
                    headers: { 'Authorization': 'Bearer ' + currentToken }
                });

                const data = await response.json();
                if (data.success && data.data) {
                    closeModal('productsModal');
                    showPaymentOptions(data.data);
                }
            } catch (error) {
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        async function createInstantTransaction(productId) {
            try {
                closeModal('paymentModal');
                showNotification('Creating instant transaction...', 'info');

                const response = await fetch('https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/payments/transactions/instant', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + currentToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        product_id: productId,
                        delivery_method: 'instant',
                        payment_method: 'midtrans'
                    })
                });

                const data = await response.json();
                
                if (data.success && data.data) {
                    const transaction = data.data.transaction;
                    
                    // Show payment instructions modal
                    const paymentModal = `
                        <div id="instantPaymentModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                            <div style="background: white; padding: 20px; border-radius: 8px; max-width: 500px; width: 90%; max-height: 80%; overflow-y: auto;">
                                <h3>💳 Payment Instructions</h3>
                                <div style="background: #e7f3ff; border: 1px solid #b8daff; padding: 12px; border-radius: 6px; margin: 15px 0;">
                                    <strong>Transaction ID:</strong> ${transaction.id}<br>
                                    <strong>Amount:</strong> Rp ${transaction.total_amount.toLocaleString('id-ID')}<br>
                                    <strong>Status:</strong> <span style="color: #856404;">⏳ Pending Payment</span>
                                </div>
                                
                                ${transaction.midtrans_redirect_url ? `
                                    <div style="margin: 20px 0;">
                                        <button class="btn btn-primary" onclick="window.open('${transaction.midtrans_redirect_url}', '_blank')" style="width: 100%; margin-bottom: 10px;">
                                            🌐 Open Midtrans Payment Page
                                        </button>
                                    </div>
                                ` : ''}
                                
                                <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 12px; border-radius: 6px; margin: 15px 0;">
                                    <strong>🚀 INSTANT DELIVERY:</strong><br>
                                    <small>Once payment is confirmed, credentials will automatically appear in this chat</small>
                                </div>
                                
                                <div style="margin: 20px 0;">
                                    <button class="btn btn-info" onclick="checkPaymentStatus('${transaction.id}')" style="margin-right: 10px;">
                                        🔄 Check Payment Status
                                    </button>
                                    <button class="btn btn-secondary" onclick="closeModal('instantPaymentModal')">
                                        ❌ Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', paymentModal);
                    showNotification('Instant transaction created! Please complete payment.', 'success');
                    
                } else {
                    throw new Error(data.error?.message || 'Failed to create transaction');
                }
            } catch (error) {
                showNotification(`Failed to create instant transaction: ${error.message}`, 'error');
            }
        }

        async function checkPaymentStatus(transactionId) {
            try {
                const response = await fetch(`https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/payments/transactions/${transactionId}/status`, {
                    headers: { 'Authorization': 'Bearer ' + currentToken }
                });

                const data = await response.json();
                
                if (data.success && data.data) {
                    const status = data.data.payment_status;
                    
                    if (status === 'paid') {
                        showNotification('✅ Payment confirmed! Credentials will appear shortly.', 'success');
                        closeModal('instantPaymentModal');
                        loadMessages(); // Refresh messages to show credentials
                    } else if (status === 'failed') {
                        showNotification('❌ Payment failed. Please try again.', 'error');
                    } else {
                        showNotification(`⏳ Payment status: ${status}`, 'info');
                    }
                } else {
                    throw new Error(data.error?.message || 'Failed to check payment status');
                }
            } catch (error) {
                showNotification(`Failed to check payment status: ${error.message}`, 'error');
            }
        }

        function selectMiddlemanForPayment(productId) {
            closeModal('paymentModal');
            
            // Get product for middleman selection
            const product = window.currentChatProduct;
            if (!product || product.id !== productId) {
                showNotification('Product context not available. Please refresh and try again.', 'error');
                return;
            }
            
            showMiddlemanSelection(product);
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }

        function enableChatInput() {
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        function logMessage(category, message, type = 'info') {
            const logsEl = document.getElementById('systemLogs');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span>[${category}]</span> ${message}
            `;
            
            logsEl.appendChild(logEntry);
            logsEl.scrollTop = logsEl.scrollHeight;
            
            // Keep only last 100 logs
            while (logsEl.children.length > 100) {
                logsEl.removeChild(logsEl.firstChild);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Rate Limit Handler
        function handleRateLimit(data) {
            const waitTime = data.wait_time || 60; // Default to 60 seconds
            const message = data.message || 'Rate limit exceeded. Please slow down.';
            
            rateLimitedUntil = Date.now() + (waitTime * 1000);
            
            // Disable send button and show countdown
            const sendBtn = document.getElementById('sendBtn');
            const messageInput = document.getElementById('messageInput');
            
            sendBtn.disabled = true;
            messageInput.disabled = true;
            messageInput.placeholder = `Rate limited - wait ${Math.ceil(waitTime)}s`;
            
            showNotification(message, 'error');
            logMessage('RATE_LIMIT', `Rate limited for ${waitTime} seconds`, 'error');
            
            // Clear any existing timer
            if (rateLimitTimer) {
                clearInterval(rateLimitTimer);
            }
            
            // Start countdown timer
            rateLimitTimer = setInterval(() => {
                const remaining = Math.max(0, rateLimitedUntil - Date.now());
                
                if (remaining <= 0) {
                    // Rate limit expired
                    clearInterval(rateLimitTimer);
                    rateLimitTimer = null;
                    rateLimitedUntil = null;
                    
                    sendBtn.disabled = false;
                    messageInput.disabled = false;
                    messageInput.placeholder = 'Type a message...';
                    
                    showNotification('You can now send messages again', 'success');
                    logMessage('RATE_LIMIT', 'Rate limit expired', 'success');
                } else {
                    // Update countdown
                    const seconds = Math.ceil(remaining / 1000);
                    messageInput.placeholder = `Rate limited - wait ${seconds}s`;
                    sendBtn.textContent = `${seconds}s`;
                }
            }, 1000);
        }

        // Check if currently rate limited
        function isRateLimited() {
            if (rateLimitedUntil && Date.now() < rateLimitedUntil) {
                return true;
            }
            
            // Clean up if expired
            if (rateLimitedUntil && Date.now() >= rateLimitedUntil) {
                rateLimitedUntil = null;
                if (rateLimitTimer) {
                    clearInterval(rateLimitTimer);
                    rateLimitTimer = null;
                }
            }
            
            return false;
        }

        // Event Handlers
        function handleNewMessage(data) {
            if (data.chat_id === activeChatId) {
                // Only add if not already present (to avoid duplicates from optimistic updates)
                if (!document.querySelector(`[data-message-id="${data.message.id}"]`)) {
                    addMessageToUI(data.message, data.message.sender_id === currentUserId);
                }
                
                // Mark as read if not from self
                if (data.message.sender_id !== currentUserId) {
                    sendWSMessage({ 
                        type: "mark_message_read", 
                        chat_id: data.chat_id, 
                        data: { message_id: data.message.id } 
                    });
                }
                
                // Refresh chat list when new message arrives
                if (myChats.length > 0) {
                    setTimeout(() => {
                        loadMyChats();
                    }, 500);
                }
            }
        }

        function handleTypingIndicator(data) {
            if (data.chat_id === activeChatId && data.user_id !== currentUserId) {
                const indicator = document.getElementById('typingIndicator');
                if (data.is_typing) {
                    indicator.textContent = `${data.username} is typing...`;
                    indicator.style.display = 'block';
                } else {
                    indicator.style.display = 'none';
                }
            }
        }

        function handleUserPresence(data) {
            if (data.chat_id === activeChatId) {
                updateOnlineUsersList(data.user_id, data.username, data.is_online);
            }
        }

        function handleReadReceipt(data) {
            const messageEl = document.querySelector(`[data-message-id="${data.message_id}"]`);
            if (messageEl) {
                const statusEl = messageEl.querySelector('.message-status');
                if (statusEl) {
                    statusEl.textContent = '✓✓';
                }
            }
        }

        function handleGroupChatCreated(data) {
            const message = `🎉 Group chat created by ${data.initiator} for product: ${data.product_title}`;
            showNotification(message, 'success');
            logMessage('GROUP', `Group chat created: ${data.chat_id}`, 'success');
            
            // Auto-join if this is the active chat or if you want to switch to it
            if (confirm(`Join the new group chat for ${data.product_title}?`)) {
                document.getElementById('activeChatId').value = data.chat_id;
                setActiveChat();
            }
        }

        function updateOnlineUsersList(userId, username, isOnline) {
            if (userId === currentUserId) return;

            if (isOnline) {
                onlineUsers.set(userId, { username, isOnline: true });
            } else {
                onlineUsers.set(userId, { username, isOnline: false });
            }

            renderOnlineUsers();
        }

        function renderOnlineUsers() {
            const container = document.getElementById('onlineUsers');
            container.innerHTML = '';

            // Add self first
            const selfDiv = document.createElement('div');
            selfDiv.className = 'user-item user-online';
            selfDiv.innerHTML = `
                <div class="user-status-dot user-status-online"></div>
                <span>You (${currentUsername})</span>
            `;
            container.appendChild(selfDiv);

            // Add others
            onlineUsers.forEach((user, userId) => {
                const userDiv = document.createElement('div');
                userDiv.className = `user-item ${user.isOnline ? 'user-online' : 'user-offline'}`;
                userDiv.innerHTML = `
                    <div class="user-status-dot ${user.isOnline ? 'user-status-online' : 'user-status-offline'}"></div>
                    <span onclick="copyUserId('${userId}')" style="cursor: pointer; flex: 1;" title="Click to copy ID">
                        ${user.username} ${user.isOnline ? '(Online)' : '(Offline)'}
                    </span>
                `;
                container.appendChild(userDiv);
            });

            if (onlineUsers.size === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'user-item user-offline';
                emptyDiv.innerHTML = `
                    <div class="user-status-dot user-status-offline"></div>
                    <span>Only you in this chat</span>
                `;
                container.appendChild(emptyDiv);
            }
        }

        // Quick Action Functions
        function testRateLimit() {
            if (!activeChatId) {
                showNotification('Please join a chat first', 'error');
                return;
            }
            
            logMessage('TEST', 'Starting rate limit test - sending 15 messages rapidly...', 'info');
            showNotification('Sending 15 messages rapidly to test rate limiter', 'info');
            
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    if (!isRateLimited()) {
                        document.getElementById('messageInput').value = `Rate test message ${i + 1} - testing spam protection`;
                        sendMessage();
                    } else {
                        logMessage('TEST', `Message ${i + 1} blocked by rate limiter`, 'info');
                    }
                }, i * 500); // Send every 500ms to trigger rate limit
            }
        }

        function testTyping() {
            if (!activeChatId || !ws || ws.readyState !== WebSocket.OPEN) {
                showNotification('WebSocket not connected or no active chat', 'error');
                return;
            }
            
            sendWSMessage({ type: "typing_start", chat_id: activeChatId });
            setTimeout(() => {
                sendWSMessage({ type: "typing_stop", chat_id: activeChatId });
            }, 3000);
            
            showNotification('Typing indicator test sent', 'info');
        }

        function sendTestMessage() {
            if (!activeChatId) {
                showNotification('Please join a chat first', 'error');
                return;
            }
            
            document.getElementById('messageInput').value = `Test message from modern UI - ${new Date().toLocaleTimeString()}`;
            sendMessage();
        }

        function clearChat() {
            document.getElementById('chatMessages').innerHTML = `
                <div style="text-align: center; color: var(--text-muted); margin-top: 50px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">💬</div>
                    <h3>Chat Cleared</h3>
                    <p>Messages cleared from UI (not from server)</p>
                </div>
            `;
        }

        async function respondToOffer(chatId, messageId, action) {
            try {
                const response = await fetch(`https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats/${chatId}/messages/${action}-offer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + currentToken
                    },
                    body: JSON.stringify({ message_id: messageId })
                });

                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Offer ${action}ed successfully!`, 'success');
                    loadMessages(); // Refresh to show updated offer
                } else {
                    throw new Error(data.error?.message || `Failed to ${action} offer`);
                }
            } catch (error) {
                showNotification(`Failed to ${action} offer: ${error.message}`, 'error');
            }
        }

        async function markAsRead() {
            if (!activeChatId) {
                showNotification('No active chat selected', 'error');
                return;
            }

            try {
                const response = await fetch(`https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats/${activeChatId}/read`, {
                    method: 'PUT',
                    headers: { 'Authorization': 'Bearer ' + currentToken }
                });

                if (response.ok) {
                    showNotification('Chat marked as read', 'success');
                } else {
                    const data = await response.json();
                    throw new Error(data.error?.message || 'Failed to mark as read');
                }
            } catch (error) {
                showNotification(`Failed to mark as read: ${error.message}`, 'error');
            }
        }

        // Input Event Listeners
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Typing indicator
        document.getElementById('messageInput').addEventListener('input', function() {
            if (!activeChatId || !ws || ws.readyState !== WebSocket.OPEN) return;

            if (typingTimeout) {
                clearTimeout(typingTimeout);
            } else {
                sendWSMessage({ type: "typing_start", chat_id: activeChatId });
            }

            typingTimeout = setTimeout(() => {
                sendWSMessage({ type: "typing_stop", chat_id: activeChatId });
                typingTimeout = null;
            }, 1000);
        });

        // Message type change
        document.getElementById('messageType').addEventListener('change', function() {
            const type = this.value;
            const attachmentInput = document.getElementById('attachmentUrl');
            const imageFiles = document.getElementById('imageFiles');
            const previewContainer = document.getElementById('imagePreviewContainer');
            const offerInput = document.getElementById('offerPrice');
            
            attachmentInput.style.display = 'none';
            imageFiles.style.display = 'none';
            previewContainer.style.display = 'none';
            offerInput.style.display = 'none';
            
            if (type === 'image') {
                attachmentInput.style.display = 'block';
                imageFiles.style.display = 'block';
                // uploadBtn.style.display = 'block'; // Remove manual upload button
                previewContainer.style.display = 'block';
                attachmentInput.placeholder = 'Image URL (or select files below - will upload when you send)';
            } else if (type === 'offer') {
                offerInput.style.display = 'block';
            }
        });

        // File input change handler for preview
        document.getElementById('imageFiles').addEventListener('change', function() {
            const files = this.files;
            showImagePreviews(files);
        });

        // Function to show image previews when files are selected
        function showImagePreviews(files) {
            const previewContainer = document.getElementById('imagePreviewContainer');
            const previewGrid = document.createElement('div');
            previewGrid.className = 'image-preview-grid';
            previewGrid.id = 'imagePreviewGrid';
            
            // Clear existing previews
            previewContainer.innerHTML = '';
            previewContainer.appendChild(previewGrid);
            
            // Show preview for each selected file with validation
            Array.from(files).forEach((file, index) => {
                const validation = validateImageFile(file);
                if (validation.valid) {
                    const previewItem = createImagePreviewItem(file, index);
                    previewGrid.appendChild(previewItem);
                } else {
                    // Show error notification for invalid files
                    showNotification(`${file.name}: ${validation.error}`, 'error');
                }
            });
        }

        // Client-side file validation
        function validateImageFile(file) {
            const maxSize = 5 * 1024 * 1024; // 5MB
            const allowedTypes = [
                'image/jpeg', 
                'image/jpg', 
                'image/png', 
                'image/gif', 
                'image/webp', 
                'image/avif'
                // Note: SVG excluded for security (XSS risks)
            ];

            // Check file size
            if (file.size > maxSize) {
                return { valid: false, error: `File too large (max 5MB)` };
            }

            // Check file type
            if (!allowedTypes.includes(file.type)) {
                return { valid: false, error: `Invalid file type. Only safe image formats allowed.` };
            }

            // Check filename for security
            if (file.name.includes('..') || file.name.includes('/') || file.name.includes('\\')) {
                return { valid: false, error: `Invalid filename` };
            }

            return { valid: true };
        }

        // Function to create image preview item
        function createImagePreviewItem(file, index) {
            const previewItem = document.createElement('div');
            previewItem.className = 'image-preview-item';
            previewItem.dataset.index = index;
            
            const img = document.createElement('img');
            img.className = 'image-preview-thumb';
            
            const overlay = document.createElement('div');
            overlay.className = 'image-preview-overlay';
            overlay.innerHTML = '<div>Will upload when sent</div>';
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'image-preview-remove';
            removeBtn.innerHTML = '×';
            removeBtn.style.display = 'flex'; // Always show remove button for selected files
            removeBtn.onclick = () => removeImagePreview(index);
            
            // Create FileReader to show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
            
            previewItem.appendChild(img);
            previewItem.appendChild(overlay);
            previewItem.appendChild(removeBtn);
            
            return previewItem;
        }

        // Function to remove image preview
        function removeImagePreview(index) {
            const previewItem = document.querySelector(`[data-index="${index}"]`);
            const url = previewItem ? previewItem.dataset.url : null;
            
            // Remove from file input
            const fileInput = document.getElementById('imageFiles');
            const dt = new DataTransfer();
            
            // Copy all files except the one to remove
            Array.from(fileInput.files).forEach((file, i) => {
                if (i !== index) {
                    dt.items.add(file);
                }
            });
            
            fileInput.files = dt.files;
            
            // Remove from attachment URLs if uploaded
            if (url) {
                const attachmentInput = document.getElementById('attachmentUrl');
                const urls = attachmentInput.value.split(',').map(u => u.trim()).filter(u => u);
                const updatedUrls = urls.filter(u => u !== url);
                attachmentInput.value = updatedUrls.join(', ');
            }
            
            showImagePreviews(fileInput.files);
        }


        // Function to update image preview status
        function updateImagePreviewStatus(index, status, url = null) {
            const previewItem = document.querySelector(`[data-index="${index}"]`);
            if (!previewItem) return;
            
            // Remove all status classes
            previewItem.classList.remove('uploading', 'uploaded', 'error');
            previewItem.classList.add(status);
            
            const overlay = previewItem.querySelector('.image-preview-overlay');
            const removeBtn = previewItem.querySelector('.image-preview-remove');
            
            switch (status) {
                case 'uploading':
                    overlay.innerHTML = '<div class="image-preview-spinner"></div>';
                    removeBtn.style.display = 'none';
                    break;
                case 'uploaded':
                    overlay.style.display = 'none';
                    removeBtn.style.display = 'flex';
                    if (url) {
                        previewItem.dataset.url = url;
                    }
                    break;
                case 'error':
                    overlay.innerHTML = '<div>Error</div>';
                    removeBtn.style.display = 'none';
                    break;
                default:
                    overlay.innerHTML = '<div>Will upload when sent</div>';
                    removeBtn.style.display = 'flex';
            }
        }

        // New function: Upload files and send messages in one go
        async function sendMessageWithFileUpload(content, files) {
            if (files.length > 5) {
                showNotification('Maximum 5 images allowed', 'error');
                return;
            }

            // Disable send button during upload
            const sendBtn = document.getElementById('sendBtn');
            const originalText = sendBtn.innerHTML;
            sendBtn.disabled = true;
            sendBtn.innerHTML = '⏳';

            try {
                const uploadedUrls = [];
                let successCount = 0;
                let failCount = 0;
                
                showNotification(`Uploading ${files.length} images...`, 'info');
                
                // Upload all files first
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // Update preview to show uploading status
                    updateImagePreviewStatus(i, 'uploading');
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('folder', 'chat-images');
                    formData.append('public', 'true'); // Make chat images public for easier access

                    try {
                        const response = await fetch('https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/files/upload', {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer ' + currentToken
                            },
                            body: formData
                        });

                        const data = await response.json();
                        if (data.success && data.data.url) {
                            uploadedUrls.push(data.data.url);
                            // Store file metadata for secure access
                            if (!window.uploadedFileMetadata) {
                                window.uploadedFileMetadata = [];
                            }
                            window.uploadedFileMetadata.push({
                                url: data.data.url,
                                id: data.data.id,
                                filename: data.data.filename
                            });
                            updateImagePreviewStatus(i, 'uploaded', data.data.url);
                            successCount++;
                            showNotification(`Uploaded ${successCount}/${files.length}: ${file.name}`, 'success');
                        } else {
                            throw new Error(`Failed to upload ${file.name}: ${data.message || 'Unknown error'}`);
                        }
                    } catch (fileError) {
                        updateImagePreviewStatus(i, 'error');
                        failCount++;
                        showNotification(`Failed to upload ${file.name}: ${fileError.message}`, 'error');
                    }
                }

                // If no uploads succeeded, stop here
                if (uploadedUrls.length === 0) {
                    showNotification('No images were uploaded successfully', 'error');
                    return;
                }

                // Now send single message with all uploaded images
                showNotification(`Sending message with ${uploadedUrls.length} images...`, 'info');
                
                const messageData = {
                    content: content || 'Images', // Use user text or default
                    type: 'image',
                    attachment_urls: uploadedUrls, // Send all URLs in one message
                    metadata: {
                        file_metadata: window.uploadedFileMetadata || [] // Include file IDs for secure access
                    }
                };
                
                try {
                    const response = await fetch(`https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats/${activeChatId}/messages`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + currentToken
                        },
                        body: JSON.stringify(messageData)
                    });
                    
                    const responseData = await response.json();
                    if (responseData.success) {
                        addMessageToUI(responseData.data, true);
                        logMessage('CHAT', `Message with ${uploadedUrls.length} images sent`, 'success');
                        showNotification(`Successfully sent message with ${uploadedUrls.length} images`, 'success');
                    } else {
                        logMessage('CHAT', `Failed to send message: ${responseData.message}`, 'error');
                        showNotification(`Failed to send message: ${responseData.message}`, 'error');
                    }
                } catch (error) {
                    logMessage('CHAT', `Error sending message: ${error.message}`, 'error');
                    showNotification(`Error sending message: ${error.message}`, 'error');
                }

                // Clear inputs and previews after sending
                document.getElementById('messageInput').value = '';
                document.getElementById('attachmentUrl').value = '';
                document.getElementById('imageFiles').value = '';
                document.getElementById('imagePreviewContainer').innerHTML = '';
                
                // Clear file metadata
                window.uploadedFileMetadata = [];
                
                // Ensure chat scrolls to bottom
                const container = document.getElementById('chatMessages');
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 100);
                
                // Stop typing indicator
                sendWSMessage({ type: "typing_stop", chat_id: activeChatId });

            } catch (error) {
                showNotification(`Upload/send failed: ${error.message}`, 'error');
            } finally {
                // Re-enable send button
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalText;
            }
        }

        // Simple and secure approach: Direct storage URLs for public chat images

        function loadSecureImage(imageId, storageUrl) {
            const imgElement = document.getElementById(imageId);
            if (!imgElement) return;
            
            // For public chat images, use direct storage URL (simple and fast) 
            imgElement.src = storageUrl;
        }

        function openSecureImage(imageUrl) {
            // Open image in new tab with security headers
            window.open(imageUrl, '_blank');
        }

        async function sendImageMessage(imageUrl) {
            if (!activeChatId || !currentToken) return;

            try {
                const response = await fetch(`https://pasargamex-api-is3vukc7iq-et.a.run.app/v1/chats/${activeChatId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + currentToken
                    },
                    body: JSON.stringify({
                        content: 'Image',
                        type: 'image',
                        attachment_url: imageUrl
                    })
                });

                const data = await response.json();
                if (data.success) {
                    // Message will be received via WebSocket
                    logMessage('CHAT', 'Image message sent', 'success');
                } else {
                    throw new Error(data.error?.message || 'Failed to send image');
                }
            } catch (error) {
                logMessage('CHAT', `Image send failed: ${error.message}`, 'error');
            }
        }

        // Payment Integration
        let paymentManager = null;

        // Initialize Payment Manager
        function initializePaymentManager() {
            const apiBaseUrl = 'https://pasargamex-api-is3vukc7iq-et.a.run.app';
            paymentManager = new PaymentManager(apiBaseUrl, ws);
            window.paymentManager = paymentManager; // Make it global for modal buttons
        }

        // Create payment transaction for a product
        async function createPaymentTransaction() {
            if (!paymentManager) {
                showNotification('Payment system not initialized', 'error');
                return;
            }

            const productId = document.getElementById('paymentProductId').value.trim();
            if (!productId) {
                showNotification('Please enter a Product ID', 'error');
                return;
            }
            
            try {
                logMessage('PAYMENT', `Creating payment for product: ${productId}`, 'info');
                const transaction = await paymentManager.createInstantTransaction(productId);
                logMessage('PAYMENT', `Payment transaction created: ${transaction.id}`, 'success');
            } catch (error) {
                logMessage('PAYMENT', `Payment failed: ${error.message}`, 'error');
            }
        }

        // Handle WebSocket payment notifications
        function handleWebSocketPaymentUpdate(data) {
            if (paymentManager) {
                paymentManager.handleWebSocketPaymentUpdate(data);
            }
            
            // Log the payment update
            if (data.type === 'payment_status_update') {
                logMessage('PAYMENT', `Payment status: ${data.transaction.payment_status}`, 'success');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            logMessage('SYSTEM', 'Modern chat testing interface loaded', 'success');
            showNotification('Welcome to PasargameX Chat Testing!', 'info');
            
            // Add real-time validation to user ID inputs
            const recipientIdInput = document.getElementById('recipientId');
            const searchUserIdInput = document.getElementById('searchUserId');
            
            recipientIdInput.addEventListener('input', function() {
                validateUserIdInput(this);
            });
            
            searchUserIdInput.addEventListener('input', function() {
                validateUserIdInput(this);
            });

            // Initialize payment manager after a delay to ensure WebSocket is ready
            setTimeout(initializePaymentManager, 1000);
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <title>PasargameX Chat WebSocket Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
        }
        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .section {
            flex: 1;
            min-width: 300px;
            margin: 0; 
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
            box-sizing: border-box;
        }
        .messages-container {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: scroll;
            padding: 10px;
            margin: 10px 0;
            background: white;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .input-group {
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap; 
        }
        .input-group label {
            min-width: 100px;
            font-weight: bold;
        }
        input, button, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        input[type="text"], input[type="password"] {
            flex: 1;
            min-width: 200px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            min-width: 100px;
        }
        button:hover { background: #0056b3; }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .message-item {
            margin: 0;
            padding: 5px;
            border-left: 3px solid #007bff;
            background: #f8f9fa;
            word-wrap: break-word;
        }
        .message-item.sent {
            border-left-color: #28a745;
            background: #e6ffe6;
        }
        .message-item.received {
            border-left-color: #ffc107;
            background: #fff8e6;
        }
        .timestamp {
            font-size: 0.8em;
            color: #666;
            text-align: right;
            display: block;
        }
        .api-section {
            background: #e7f3ff;
            border-color: #007bff;
        }
        .ws-section {
            background: #fff3cd;
            border-color: #ffc107;
        }
        .rest-results {
            background: white;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 0.9em;
        }
        h2, h3 {
            color: #333;
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        .chat-room-section {
            flex-basis: 100%;
            background: #e0f7fa;
            border-color: #00bcd4;
        }
        .chat-messages-display {
            height: 400px;
            border: 1px solid #a7d9e2;
            background: #ffffff;
            padding: 10px;
            overflow-y: auto;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .chat-message-bubble {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 15px;
            margin-bottom: 5px;
            word-wrap: break-word;
            font-size: 0.95em;
        }
        .chat-message-bubble.self {
            background-color: #dcf8c6;
            align-self: flex-end;
        }
        .chat-message-bubble.other {
            background-color: #e0e0e0;
            align-self: flex-start;
        }
        .chat-message-bubble .sender-name {
            font-weight: bold;
            font-size: 0.85em;
            color: #555;
            margin-bottom: 3px;
        }
        .chat-message-bubble .message-content {
            margin-bottom: 3px;
        }
        .chat-message-bubble .message-timestamp {
            font-size: 0.7em;
            color: #888;
            text-align: right;
        }
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .section {
                min-width: unset;
                width: 100%;
            }
            .input-group {
                flex-direction: column;
                align-items: flex-start;
            }
            .input-group label {
                min-width: unset;
                width: 100%;
            }
            input[type="text"], input[type="password"] {
                width: 100%;
                min-width: unset;
            }
            button {
                width: 100%;
                min-width: unset;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ PasargameX Chat System Test</h1>
        
        <div class="section api-section">
            <h2>üîê Authentication</h2>
            <div class="input-group">
                <label>Email:</label>
                <input type="text" id="loginEmail" placeholder="your_email@example.com" value="javierroyality@gmail.com">
            </div>
            <div class="input-group">
                <label>Password:</label>
                <input type="password" id="loginPassword" placeholder="your_password" value="password">
            </div>
            <div class="input-group">
                <label></label>
                <button onclick="login()">Login</button>
                <span id="loginStatus"></span>
            </div>
            <div class="input-group">
                <label>JWT Token:</label>
                <input type="text" id="token" placeholder="Token will appear here after login" readonly style="background: #f8f9fa;">
            </div>
            <div class="input-group">
                <label>Current User ID:</label>
                <input type="text" id="currentUserIdDisplay" placeholder="Your User ID" readonly style="background: #f8f9fa;">
            </div>
        </div>

        <div class="section api-section">
            <h2>üîó REST API Testing</h2>
            
            <h3>Create Chat</h3>
            <div class="input-group">
                <label>Recipient ID:</label>
                <input type="text" id="recipientId" placeholder="Enter recipient user ID" value="hS25329WNmPd1xzYknizpYpBaSx2">
            </div>
            <div class="input-group">
                <label>Product ID:</label>
                <input type="text" id="productId" placeholder="Optional product ID">
            </div>
            <div class="input-group">
                <label>Initial Message:</label>
                <input type="text" id="initialMessage" placeholder="Hi, I'm interested in this product!">
            </div>
            <div class="input-group">
                <label></label>
                <button onclick="createChat()">Create Chat</button>
                <button onclick="getUserChats()">Get My Chats</button>
            </div>

            <h3>Send Message to Chat (REST)</h3>
            <div class="input-group">
                <label>Chat ID:</label>
                <input type="text" id="chatIdForMessage" placeholder="Enter chat ID">
            </div>
            <div class="input-group">
                <label>Message:</label>
                <input type="text" id="messageContent" placeholder="Type your message">
            </div>
            <div class="input-group">
                <label></label>
                <button onclick="sendRestMessage()">Send Message (REST)</button>
                <button onclick="getChatMessages()">Get Messages (REST)</button>
            </div>

            <div class="rest-results" id="restResults">
                <em>API responses will appear here...</em>
            </div>
        </div>

        <div class="section ws-section">
            <h2>‚ö° WebSocket Testing</h2>
            
            <div class="input-group">
                <button id="connect" onclick="connectWS()">Connect WebSocket</button>
                <button id="disconnect" onclick="disconnectWS()" disabled>Disconnect</button>
                <div id="status" class="status disconnected">Disconnected</div>
            </div>
            
            <div class="messages-container" id="wsMessages">
                <em>WebSocket messages will appear here...</em>
            </div>
        </div>

        <div class="section chat-room-section">
            <h2>üí¨ Chat Room (Real-time)</h2>
            <div class="input-group">
                <label>Active Chat ID:</label>
                <input type="text" id="activeChatId" placeholder="Enter Chat ID to view"> 
                <button onclick="setActiveChatId()">Set Active Chat</button> <button onclick="loadChatRoomMessages()">Load Chat Messages</button>
                <button onclick="markChatAsRead()">Mark as Read</button>
            </div>
            <div class="chat-messages-display" id="chatRoomMessages">
                <em>Messages will appear here...</em>
            </div>
            <div class="input-group">
                <input type="text" id="chatRoomMessageInput" placeholder="Type your message here..." disabled>
                <button id="sendChatRoomMessage" onclick="sendChatRoomMessage()" disabled>Send</button>
            </div>
            <div id="typingIndicator" style="font-style: italic; color: #888; display: none;"></div>
            <div id="onlineStatusIndicator" style="font-style: italic; color: #888;"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentToken = '';
        let currentUserId = '';
        let currentUsername = ''; // To display sender name in chat
        let typingTimeout = null; // For typing indicator

        // Authentication
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }

            try {
                const response = await fetch('http://localhost:8080/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (response.ok && (data.success || data.token)) {
                    // Handle new format (with success wrapper)
                    if (data.success) {
                        currentToken = data.data.token;
                        currentUserId = data.data.user.id;
                        currentUsername = data.data.user.username;
                    }
                    // Handle current format (direct response)
                    else if (data.token) {
                        currentToken = data.token;
                        currentUserId = data.user.id;
                        currentUsername = data.user.username;
                    }
                    
                    document.getElementById('token').value = currentToken;
                    document.getElementById('currentUserIdDisplay').value = currentUserId;
                    document.getElementById('loginStatus').textContent = `‚úÖ Logged in as: ${currentUsername} (${currentUserId})`;
                    document.getElementById('loginStatus').style.color = 'green';
                    
                    addRestResult('Login Success', data);
                } else {
                    throw new Error(data.error?.message || data.message || 'Login failed');
                }
            } catch (error) {
                document.getElementById('loginStatus').textContent = '‚ùå ' + error.message;
                document.getElementById('loginStatus').style.color = 'red';
                addRestResult('Login Error', { error: error.message });
            }
        }

        // REST API Functions
        async function createChat() {
            if (!currentToken) {
                alert('Please login first');
                return;
            }

            const recipientId = document.getElementById('recipientId').value;
            const productId = document.getElementById('productId').value;
            const initialMessage = document.getElementById('initialMessage').value;

            if (!recipientId) {
                alert('Please enter recipient ID');
                return;
            }

            try {
                const response = await fetch('http://localhost:8080/v1/chats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + currentToken
                    },
                    body: JSON.stringify({
                        recipient_id: recipientId,
                        product_id: productId || undefined,
                        initial_message: initialMessage || undefined
                    })
                });

                const data = await response.json();
                addRestResult('Create Chat', data);
                
                if (data.success && data.data.id) {
                    document.getElementById('chatIdForMessage').value = data.data.id;
                    document.getElementById('activeChatId').value = data.data.id; // Set active chat ID
                    loadChatRoomMessages(); // Load messages for the newly created/reused chat
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        sendWSMessage({ type: "join_chat_room", chat_id: data.data.id }); // Notify backend of active chat room
                    }
                }
            } catch (error) {
                addRestResult('Create Chat Error', { error: error.message });
            }
        }

        async function getUserChats() {
            if (!currentToken) {
                alert('Please login first');
                return;
            }

            try {
                const response = await fetch('http://localhost:8080/v1/chats', {
                    headers: {
                        'Authorization': 'Bearer ' + currentToken
                    }
                });

                const data = await response.json();
                addRestResult('Get User Chats', data);
                if (data.success && data.data.items && data.data.items.length > 0) {
                    // Optionally set the first chat as active for testing
                    document.getElementById('activeChatId').value = data.data.items[0].id;
                    document.getElementById('chatIdForMessage').value = data.data.items[0].id;
                    loadChatRoomMessages();
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        sendWSMessage({ type: "join_chat_room", chat_id: data.data.items[0].id }); // Notify backend of active chat room
                    }
                }
            } catch (error) {
                addRestResult('Get Chats Error', { error: error.message });
            }
        }

        async function sendRestMessage() {
            if (!currentToken) {
                alert('Please login first');
                return;
            }

            const chatId = document.getElementById('chatIdForMessage').value;
            const content = document.getElementById('messageContent').value;

            if (!chatId || !content) {
                alert('Please enter chat ID and message content');
                return;
            }

            try {
                const response = await fetch(`http://localhost:8080/v1/chats/${chatId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + currentToken
                    },
                    body: JSON.stringify({
                        content: content,
                        type: 'text'
                    })
                });

                const data = await response.json();
                addRestResult('Send Message (REST)', data);
                
                if (data.success) {
                    document.getElementById('messageContent').value = '';
                    // No need to manually add to chat room, WebSocket will handle it for others
                    // For self, optimistic update is in sendChatRoomMessage
                }
            } catch (error) {
                addRestResult('Send Message (REST) Error', { error: error.message });
            }
        }

        async function getChatMessages() {
            if (!currentToken) {
                alert('Please login first');
                return;
            }

            const chatId = document.getElementById('chatIdForMessage').value;
            if (!chatId) {
                alert('Please enter chat ID');
                return;
            }

            try {
                const response = await fetch(`http://localhost:8080/v1/chats/${chatId}/messages`, {
                    headers: {
                        'Authorization': 'Bearer ' + currentToken
                    }
                });

                const data = await response.json();
                addRestResult('Get Messages (REST)', data);
            } catch (error) {
                addRestResult('Get Messages (REST) Error', { error: error.message });
            }
        }

        // WebSocket Functions
        function connectWS() {
            if (!currentToken) {
                alert('Please login first');
                return;
            }
            if (ws && ws.readyState === WebSocket.OPEN) {
                alert('WebSocket is already connected.');
                return;
            }

            try {
                ws = new WebSocket(`ws://localhost:8080/ws?token=${currentToken}`);
                
                ws.onopen = function() {
                    updateStatus('Connected', true);
                    document.getElementById('connect').disabled = true;
                    document.getElementById('disconnect').disabled = false;
                    document.getElementById('chatRoomMessageInput').disabled = false;
                    document.getElementById('sendChatRoomMessage').disabled = false;
                    
                    addWSMessage('System: Connected to WebSocket');

                    // If an active chat is already set, join the room
                    const activeChatId = document.getElementById('activeChatId').value;
                    if (activeChatId) {
                        sendWSMessage({ type: "join_chat_room", chat_id: activeChatId });
                    }
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'auth_success') {
                            addWSMessage('üîê Authentication successful!');
                        } else if (data.type === 'auth_error') {
                            addWSMessage('‚ùå Authentication failed: ' + (data.data && data.data.message ? data.data.message : 'Unknown error'));
                            disconnectWS();
                        } else if (data.type === 'message_received') {
                            addWSMessage('‚úÖ Message confirmed received by server');
                        } else if (data.type === 'new_message') {
                            addWSMessage('üì® New message notification: ' + JSON.stringify(data, null, 2));
                            // Automatically add to chat room if it's the active chat
                            const activeChatId = document.getElementById('activeChatId').value;
                            if (activeChatId === data.chat_id) {
                                addMessageToChatRoom(data.message, data.sender);
                                // Mark message as read when received and displayed
                                sendWSMessage({ type: "mark_message_read", chat_id: data.chat_id, data: { message_id: data.message.id } });
                            }
                        } else if (data.type === 'typing_indicator') {
                            const typingIndicatorEl = document.getElementById('typingIndicator');
                            const activeChatId = document.getElementById('activeChatId').value;
                            if (activeChatId === data.chat_id && data.user_id !== currentUserId) {
                                if (data.is_typing) {
                                    typingIndicatorEl.textContent = `${data.username} is typing...`;
                                    typingIndicatorEl.style.display = 'block';
                                } else {
                                    typingIndicatorEl.style.display = 'none';
                                }
                            }
                        } else if (data.type === 'user_presence') {
                            const onlineStatusIndicatorEl = document.getElementById('onlineStatusIndicator');
                            const activeChatId = document.getElementById('activeChatId').value;
                            if (activeChatId === data.chat_id && data.user_id !== currentUserId) {
                                if (data.is_online) {
                                    onlineStatusIndicatorEl.textContent = `${data.username} is online.`;
                                    onlineStatusIndicatorEl.style.color = 'green';
                                } else {
                                    onlineStatusIndicatorEl.textContent = `${data.username} is offline.`;
                                    onlineStatusIndicatorEl.style.color = 'red';
                                }
                            }
                        } else if (data.type === 'message_read_receipt') {
                            addWSMessage(`‚úî‚úî Message ${data.message_id} read by ${data.reader_id}`);
                            // In a real app, you'd update the UI of the sent message here
                        }
                        else {
                            addWSMessage('üì® Received: ' + JSON.stringify(data, null, 2));
                        }
                    } catch (e) {
                        addWSMessage('üì® Received (Raw): ' + event.data);
                    }
                };
                
                ws.onclose = function() {
                    updateStatus('Disconnected', false);
                    document.getElementById('connect').disabled = false;
                    document.getElementById('disconnect').disabled = true;
                    document.getElementById('chatRoomMessageInput').disabled = true;
                    document.getElementById('sendChatRoomMessage').disabled = true;
                    
                    addWSMessage('System: Disconnected from WebSocket');
                    // Notify backend of leaving active chat room
                    const activeChatId = document.getElementById('activeChatId').value;
                    if (activeChatId) {
                        sendWSMessage({ type: "leave_chat_room", chat_id: activeChatId });
                    }
                };
                
                ws.onerror = function(error) {
                    addWSMessage('‚ùå WebSocket Error: ' + error.message);
                };
            } catch (error) {
                addWSMessage('‚ùå Connection Error: ' + error.message);
            }
        }

        function disconnectWS() {
            if (ws) {
                // Notify backend of leaving active chat room before closing
                const activeChatId = document.getElementById('activeChatId').value;
                if (activeChatId && ws.readyState === WebSocket.OPEN) {
                    sendWSMessage({ type: "leave_chat_room", chat_id: activeChatId });
                }
                ws.close();
            }
        }

        // Generic WS message sender
        function sendWSMessage(messageData) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(messageData));
            } else {
                console.error("WebSocket not connected. Cannot send message:", messageData);
            }
        }

        // Chat Room Specific Functions
        function setActiveChatId() {
            const newChatId = document.getElementById('activeChatId').value;
            if (newChatId) {
                // If already in a chat room, leave it first
                const oldChatId = document.getElementById('activeChatId').dataset.currentChatId;
                if (oldChatId && oldChatId !== newChatId && ws && ws.readyState === WebSocket.OPEN) {
                    sendWSMessage({ type: "leave_chat_room", chat_id: oldChatId });
                }
                document.getElementById('activeChatId').dataset.currentChatId = newChatId; // Store current active chat
                loadChatRoomMessages();
                if (ws && ws.readyState === WebSocket.OPEN) {
                    sendWSMessage({ type: "join_chat_room", chat_id: newChatId }); // Notify backend of active chat room
                }
            } else {
                alert('Please enter a Chat ID.');
            }
        }

        async function loadChatRoomMessages() {
            if (!currentToken) {
                alert('Please login first');
                return;
            }
            const chatId = document.getElementById('activeChatId').value;
            if (!chatId) {
                alert('Please enter an active Chat ID');
                return;
            }

            try {
                const response = await fetch(`http://localhost:8080/v1/chats/${chatId}/messages`, {
                    headers: {
                        'Authorization': 'Bearer ' + currentToken
                    }
                });
                const data = await response.json();

                const chatRoomMessagesEl = document.getElementById('chatRoomMessages');
                chatRoomMessagesEl.innerHTML = ''; // Clear existing messages

                if (data.success && data.data.items) {
                    data.data.items.reverse().forEach(message => { // Display in chronological order
                        addMessageToChatRoom(message, message.sender);
                    });
                    chatRoomMessagesEl.scrollTop = chatRoomMessagesEl.scrollHeight; // Scroll to bottom
                } else {
                    chatRoomMessagesEl.innerHTML = `<em>Failed to load messages: ${data.error?.message || 'Unknown error'}</em>`;
                }
            } catch (error) {
                chatRoomMessagesEl.innerHTML = `<em>Error loading messages: ${error.message}</em>`;
            }
        }

        function addMessageToChatRoom(message, senderInfo) {
            const chatRoomMessagesEl = document.getElementById('chatRoomMessages');
            const messageBubble = document.createElement('div');
            messageBubble.className = 'chat-message-bubble';

            const isSelf = message.sender_id === currentUserId;
            messageBubble.classList.add(isSelf ? 'self' : 'other');

            const senderName = senderInfo ? senderInfo.username : 'Unknown';
            const messageTime = new Date(message.created_at).toLocaleTimeString();

            messageBubble.innerHTML = `
                <div class="sender-name">${isSelf ? 'You' : senderName}</div>
                <div class="message-content">${message.content}</div>
                <div class="message-timestamp">${messageTime}</div>
            `;
            chatRoomMessagesEl.appendChild(messageBubble);
            chatRoomMessagesEl.scrollTop = chatRoomMessagesEl.scrollHeight; // Scroll to bottom
        }

        async function sendChatRoomMessage() {
            const chatId = document.getElementById('activeChatId').value;
            const content = document.getElementById('chatRoomMessageInput').value.trim();

            if (!chatId || !content) {
                alert('Please select an active chat and type a message.');
                return;
            }

            try {
                const response = await fetch(`http://localhost:8080/v1/chats/${chatId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + currentToken
                    },
                    body: JSON.stringify({
                        content: content,
                        type: 'text'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    document.getElementById('chatRoomMessageInput').value = '';
                    // Optimistic update for sender: add message to UI immediately
                    addMessageToChatRoom(data.data, { id: currentUserId, username: currentUsername });
                    // Send typing_stop after sending message
                    sendWSMessage({ type: "typing_stop", chat_id: chatId });
                } else {
                    alert('Failed to send message: ' + (data.error?.message || 'Unknown error'));
                }
            } catch (error) {
                alert('Error sending message: ' + error.message);
            }
        }

        async function markChatAsRead() {
            if (!currentToken) {
                alert('Please login first');
                return;
            }
            const chatId = document.getElementById('activeChatId').value;
            if (!chatId) {
                alert('Please enter an active Chat ID');
                return;
            }

            try {
                const response = await fetch(`http://localhost:8080/v1/chats/${chatId}/read`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + currentToken
                    }
                });

                if (response.ok) {
                    alert('Chat marked as read!');
                } else {
                    const data = await response.json();
                    alert('Failed to mark chat as read: ' + (data.error?.message || 'Unknown error'));
                }
            } catch (error) {
                alert('Error marking chat as read: ' + error.message);
            }
        }

        // Typing indicator logic
        document.getElementById('chatRoomMessageInput').addEventListener('input', function() {
            const chatId = document.getElementById('activeChatId').value;
            if (!chatId || !ws || ws.readyState !== WebSocket.OPEN) return;

            // Clear previous timeout
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            } else {
                // Only send typing_start if not already typing
                sendWSMessage({ type: "typing_start", chat_id: chatId });
            }

            // Set a timeout to send typing_stop after a short delay
            typingTimeout = setTimeout(() => {
                sendWSMessage({ type: "typing_stop", chat_id: chatId });
                typingTimeout = null;
            }, 1000); // Send stop after 1 second of no input
        });


        // Helper Functions
        function updateStatus(status, connected) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = status;
            statusEl.className = 'status ' + (connected ? 'connected' : 'disconnected');
        }

        function addWSMessage(message) {
            const messagesEl = document.getElementById('wsMessages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message-item';
            messageEl.innerHTML = `
                <div class="timestamp">${new Date().toLocaleTimeString()}</div>
                <div>${message}</div>
            `;
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function addRestResult(title, data) {
            const resultsEl = document.getElementById('restResults');
            const resultEl = document.createElement('div');
            resultEl.innerHTML = `
                <strong>${title}</strong> <span class="timestamp">(${new Date().toLocaleTimeString()})</span>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            resultsEl.prepend(resultEl); // Add to top
            resultsEl.scrollTop = 0; // Keep scroll at top for new results
        }

        // Allow sending message with Enter key
        document.getElementById('messageContent').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendRestMessage();
            }
        });
        
        document.getElementById('chatRoomMessageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatRoomMessage();
            }
        });
        
        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            // Pre-fill login for convenience
            document.getElementById('loginEmail').value = 'javierroyality@gmail.com';
            document.getElementById('loginPassword').value = 'password';
            // You might want to remove these pre-fills in a real app
        });
    </script>
</body>
</html>